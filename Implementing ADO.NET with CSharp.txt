Implementing ADO.NET with C#
----------------------------

Classes do ADO.NET
----------------------

    . O que é ADO.NET?

        . ADO (ActiveX Data Objects) é uma das tecnologias de acesso a dados da Microsoft, que podemos comunicar
            com diferentes banco de dados. Faz parte do .NET Framework, serve para conectar aplicações .NET
            (Console, WCF, WPF, Windows, MVC, Web Form, etc.). Os bancos de dados podem ser: SQL Server, Oracle, MySQL, XML, 
            etc. ADO.NET consiste em um conjunto de classes predefinidas utilizadas para conectar, resgatar, inserir, 
            atualizar e eliminar dados em operações CRUD nesses bancos.

    . Principais componentes do ADO.NET:

        . Connection - Cria uma conexão com o banco de dados.

        . Transaction - Executa comandos dentro de uma transação.

        . Command - Envia DMLs para o banco de dados.

        . DataAdapter - É usado para preencher um DataSet, ou um DataTable com dados.

        . DataReader - Um rápido, forward-only cursor para leitura de dados.

        . ParameterCollection - Stores all parameters related to a Command and the mappings of
                                both table and column names to the DataSet columns.

        . Parameter - Defines parameters for parameterized SQL statements and stored procedures.

    . Classes Desconectadas:

        . DataSet - Coleção de um, ou mais, DataTables.

        . DataTable - Uma simples representação de uma tabela de dados.

        . DataView - Uma consulta dentro do DataTable.

        . DataRow - Uma linha de dados dentro do DataTable.

        . DataColumn - Uma coluna de dado num DataRow.

    . Classes de Construção:

        . ConnectionStringBuilder - Cria, ou quebra uma string de conexão.

        . CommandBuilder - Cria um comando insert, update, ou delete.

    . Provedores de dados:

        . Um provedor de conexão conecta fontes de dados como SQL Server, MySQL, Oracle, etc; promovendo um 
            caminho para executar comandos 

        . SQL Server - System.Data.SqlClient

            . Conjunto de classes que fazem parte deste provider são: SqlConnection, SqlCommand, SqlDataAdapter, etc.

        . OLE DB - System.Data.OleDb

            . Conjunto de classes que fazem parte deste provider são: OleDbConnection, OleDbCommand, OleDbDataAdapter, etc.

        . ODBC - System.Data.Odbc

            . Conjunto de classes são: OdbcConnection, OdbcCommand, OdbcDataAdapter, etc.

        . Oracle - System.Data.OracleClient

            . Conjunto de classes são: OracleConnection, OracleCommand, OracleDataAdapter, etc.

        . MySQL - MySql.Data.MySqlClient

            . Conjunto de classes são: MySqlConnection, MySqlCommand, MySqlAdapter

            . https://zetcode.com/csharp/mysql/

            . https://csharp.hotexamples.com/pt/examples/MySql.Data.MySqlClient/MySqlConnection/CreateCommand/php-mysqlconnection-createcommand-method-examples.html

            . https://dev.mysql.com/doc/connector-net/en/connector-net-introduction.html

            . https://dev.mysql.com/doc/connector-net/en/connector-net-tutorials-intro.html


ORMs and ADO.NET
----------------

    . Exemplos de ORMs:

        . EF
        . Dapper
        . NHibernate

    . Possui auto mapper.

    . Abstrai o banco de dados em objetos.

    . Podemos utilizar a linguagem LINQ (Trata-se de um “framework” dentro do .NET destinado a auxiliar os 
        desenvolvedores a escrever expressões de consulta diretamente em C# de maneira agnóstica)

        . Abstrai a complexidade envolvida na utilização de diferentes linguagens de consulta, como SQL, xPath e xQuery. 
            Essa abstração é feita em cima de uma API de alto nível compatível com as linguagens integrantes do .NET Framework. 
            Ou seja: você consegue consultar uma base de dados relacional, um arquivo XML uma coleção de objetos através 
            de uma API unificada, invocada através de uma linguagem integrante do .NET Framework. 
            
        . Trazendo para um exemplo mais palpável: você consegue unicamente com código C# fazer consultas a conjuntos de objetos, 
            bases de dados relacionais e arquivos XML, sendo o LINQ o encarregado de fazer a devida “tradução” para cada 
            uma das fontes a serem consultadas.


The Connection Class
--------------------

    . Passando string de conexão:

        var cnn = new SqlConnection( cnnString );

    . Podemos utilizar para o comando acima ODBC, SqlServer, OleDb, MySQL, etc.

    . Abrindo conexão:

        cnn.Open();

    . Fechando a conexão:

        cnn.Close();

    . Descartando recursos não gerenciados:

        cnn.Dispose();

    . using (ou using var) garante que o objeto que implementa IDisposable tenha Dispose() chamado automaticamente ao 
        sair do escopo — mesmo se ocorrer uma exceção. É equivalente a um try/finally que chama Dispose().

        using (MySqlConnection con = new MySqlConnection(cs))
        {
            ...

            // con.Dispose();       Neste caso não precisa, porque utiliza o bloco "using", desde que implemente a interface "IDispose" 

        }   // Dispose chamado aqui


        ou

        using var conn = new  MySqlConnection(cs)

        conn.Open();
        // Dispose chamado ao final do método/escopo


    . Criar com new sozinho não chama Dispose() automaticamente; você precisa chamar Close()/Dispose() manualmente 
        (normalmente dentro de um try/finally). Sem isso, o fechamento/retorno da conexão ao pool fica dependente 
        do GC (não-determinístico), podendo causar esgotamento do pool.

         MySqlConnection con = new MySqlConnection(cs);

         con.Dispose(); // Quase que obrigado fazer o dispose neste casso com o uso do "new"

Demo
----

    . Digite os comandos abaixo no prompt do sistema operacional:

        cd /workspace-dotnet
        mkdir ADONet
        cd ADONet
        dotnet new sln --name ADONET
        dotnet new console -n AdoNetSystem -o adoNetSystem
        dotnet sln add adoNetSystem
        cd adoNetSystem
        dotnet add package MySql.Data
        code .

    . Instalando o MySQL

        # Criando container com nome o banco de dados MySQL
        docker container run -e MYSQL_ROOT_PASSWORD=root -p 3306:3306 --name adoNetSystemDb -d mysql:8.0.36 --default-authentication-plugin=mysql_native_password
        
        docker start adoNetSystemDb

        docker ps -a
        docker exec -it adoNetSystemDb mysql -u root -p	

        docker stop adoNetSystemDb

    . Criando o banco de dados

        docker exec -it adoNetSystemDb mysql -u root -p	

        CREATE DATABASE adoNetSystem;

        USE adoNetSystem;

        CREATE TABLE cliente(   codigo          bigint NOT NULL AUTOINCREMENT PRIMARY KEY,
                                nome            VARCHAR(50),
                                dataAniversario DATE);



Openning a Connection
---------------------

    . Para abrirmos uma conexão precisamos de uma string de conexão:
  
        string cs = @"server=localhost;userid=marco;password=brasil2;database=desenv";

        . O caracter "@" serve para preservar os caracteres especiais dentro da expressão string. Para mais detalhes
            do caracter "@", consulte o link: http://www.macoratti.net/14/01/c_arroba.htm

        . Dentro da expressão string é necessário fornecer todos os detalhes da conexão, como por exemplo:
            o nome do servidor, usuário, senha, database, etc. Isto irá variar de banco para banco.

        . Para encontrar as diversas formas de montar uma string de conexão acesse o site https://www.connectionstrings.com/

Demo
----

    . Crie a pasta "AdoNet" dentro do projeto "adoNetSystem" e crie a classe abaixo dentro 

        using System;
        using System.Text;
        using MySql.Data.MySqlClient;

        namespace AdoNet;

        public class ConnectionModel : IDisposable
        {

            public void OpenConnection()
            {

                string cs = @"server=localhost;userid=root;password=root;database=adoNetSystem";

                using (MySqlConnection con = new MySqlConnection(cs))
                {
                    con.Open();

                    string connectionInformation = GetConnectionInformation(con);

                    Console.WriteLine(connectionInformation);

                    // fechará a conexão com o servidor conforme definido na string de conexão
                    con.Close();

                    // Limpará completamente, removendo todos os recursos não gerenciados, evitando que a conexão 
                    // seja usada novamente. Uma vez que descartado é chamado, você não deve mais tentar usar o objeto. 
                    // con.Dispose();       // Não está sendo usado porque a conexão foi chamada dentro de um bloco "using"
                }
            }

            public string GetConnectionInformation(MySqlConnection con)
            {
                StringBuilder sb = new StringBuilder(1024);

                sb.AppendLine("Connection String: " + con.ConnectionString);
                sb.AppendLine("State: " + con.State.ToString());
                sb.AppendLine("Connection Timeout: " + con.ConnectionTimeout.ToString());
                sb.AppendLine("Database: " + con.Database);
                sb.AppendLine("Data Source: " + con.DataSource);
                sb.AppendLine("Server Version: " + con.ServerVersion);
                //            sb.AppendLine("Workstation ID: " + con.WorkstationId);

                return sb.ToString();

            }

            void IDisposable.Dispose()
            {
                throw new NotImplementedException();
            }

        }

        . No método "OpenConnection()" utilizamos o bloco "using". Um detalhe para se destacar que a classe "ConnectionModel" precisa
            implementar a interface "IDisposable" se quisermos utiliza-la num bloco "using". Neste caso, implementaremos o método "IDisposable.Dispose()"
            nesta classe para liberar recursos utilizados pela classe em questão. Para mais detalhes acesse: https://www.devmedia.com.br/entendendo-o-bloco-using-no-csharp/16967


    . Acesse a classe Programa.cs e altere todo o código abaixo:

        using AdoNet;

        ConnectionModel cm = new ConnectionModel();

        cm.OpenConnection();

    . Catching Connection Exceptions

        . Implemente o bloco Try, catch dentro do método "OpenConnection" como abaixo:

            public void OpenConnection(){

                // Bloco try/catch inserido
                try{
                    string cs = @"server=localhost;userid=marco;password=brasil2;database=desenv";

                    using ( MySqlConnection con = new MySqlConnection(cs)){
                        con.Open();

                        string connectionInformation = GetConnectionInformation(con);

                        Console.WriteLine( connectionInformation );

                        con.Close();

                        con.Dispose();
                    }
                }
                catch( Exception ex){
                    throw new Exception( "Ocorreu o seguinte Erro: " + ex.ToString());
                }
            }

        . Altere alguma informação da string de conexão para dar erro e cair na excessão, ou retire o docker container do arq.

    . Execute o projeto.

. SQLCommand

    . SqlCommand é a classe do ADO.NET responsável por representar um comando SQL que será executado no banco de dados.

    . Ela pode executar:

        SELECT

        INSERT

        UPDATE

        DELETE

        Stored Procedures

    . Exemplo

        using System.Data.SqlClient;

        var command = new SqlCommand(
            "SELECT COUNT(*) FROM Usuarios",
            connection
        );

    . Método "ExecuteScalar"

        . É um método do SqlCommand usado quando, você espera apenas um único valor como retorno.

        . Características importantes:

            . Executa o comando SQL

            . Retorna somente a primeira coluna da primeira linha

            . Ignora o resto do resultado

        . Exemplo:

            using (var connection = new SqlConnection(connectionString))
            {
                connection.Open();

                var command = new SqlCommand(
                    "SELECT COUNT(*) FROM Usuarios",
                    connection
                );

                int totalUsuarios = (int)command.ExecuteScalar();
            }

    . Método "ExecuteNonQuery"

        . Executa comandos SQL que:

            . Não retornam ResultSets (SELECT)

            . Alteram o estado do banco de dados

            . É usado principalmente para:

                INSERT

                UPDATE

                DELETE

                CREATE / ALTER / DROP

        . Exemplo:

            using (SqlConnection conn = new SqlConnection(connectionString))
            {
                string sql = "INSERT INTO Cliente (Nome, Email) VALUES (@Nome, @Email)";

                using (SqlCommand cmd = new SqlCommand(sql, conn))
                {
                    cmd.Parameters.AddWithValue("@Nome", "Marco");
                    cmd.Parameters.AddWithValue("@Email", "marco@email.com");

                    conn.Open();

                    int linhasAfetadas = cmd.ExecuteNonQuery();
                }
            }

    . Método "ExecuteReader"

        . Retorna um DataReader com os dados da consulta e executa apenas o comando SELECT.
            Use quando for preencher um DropDownList, CheckBoxList, RadioButtonList. ExecuteReader é somente leitura e 
            não pode ser usado para outros fins.

        . O que acontece internamente:

            . O SqlCommand envia o SQL ao banco

            . O banco começa a enviar os dados

            . O C# cria um SqlDataReader

            . Os dados são lidos linha a linha (forward-only)

        . É rápido e consome pouca memória. Não permite voltar para registros anteriores

        . Exemplo:

            using (SqlConnection conn = new SqlConnection(connectionString))
            {
                string sql = "SELECT Id, Nome, Email FROM Cliente";

                using (SqlCommand cmd = new SqlCommand(sql, conn))
                {
                    conn.Open();
                                                
                    using (SqlDataReader reader = cmd.ExecuteReader())
                    {
                        while (reader.Read())   // Read() - avança para a próxima linha e Retorna true enquanto houver dados
                        {
                            int id = reader.GetInt32(0);
                            string nome = reader.GetString(1);
                            string email = reader.GetString(2);
                        }
                    }
                }
            }

        . Formas de acessar os dados:

            reader.GetString(2);        reader.GetInt32(0);

            reader["Nome"].ToString();      // Mais legível, porém um pouco mais lento.

            
            string? email = reader.IsDBNull(2) ? null : reader.GetString(2);        // Verificando NULL

        . Claúsula WHERE

            string sql = "SELECT Nome FROM Cliente WHERE Id = @Id";

            cmd.Parameters.AddWithValue("@Id", 1);

    . Quando usar:

        . Se não retorna dados → ExecuteNonQuery

        . Se retorna muitas linhas → ExecuteReader

        . Se retorna um único valor → ExecuteScalar

. Demo
------

    . Implemente o método abaixo na classe "ConnectionModel".

        ...
        public string GetClientesCountScala()
        {
            string version = string.Empty;

            try
            {

                string cs = @"server=localhost;userid=root;password=root;database=adoNetSystem";

                string sql = "SELECT VERSION()";

                using (MySqlConnection con = new MySqlConnection(cs))
                {
                    using (MySqlCommand cmd = new MySqlCommand(sql, con))
                    {
                        con.Open();

                        version = (string)cmd.ExecuteScalar();

                        Console.WriteLine($"A versão do Servidor MySQL é: {version}");
                    }
                }
            }
            catch (Exception ex)
            {
                throw new Exception("Ocorreu o seguinte Erro: " + ex.ToString());
            }

            return version;
        }
        ...

    . Implemente a linha abaixo na classe "Program.cs":

        using AdoNet;

        ConnectionModel cm = new ConnectionModel();

        // Apague a linha abaixo
        // cm.OpenConnection();

        // Insira a linha abaixo
        string version = cm.GetClientesCountScala();

    . Execute o projeto debugando a partir da linha acima da classe "ConnectionModel" e veja o resultado.

    . Implemente o método abaixo na classe ConnectionModel.cs:

        // Linha inserida
        using System.Data;
        ...

        // Método inserido
        public long InsertCliente()
        {
            long rowsAffected = 0;
            string cs = @"server=localhost;userid=root;password=root;database=adoNetSystem";

            try
            {
                using (MySqlConnection cn = new MySqlConnection(cs))
                {
                    cn.Open();

                    var dml = "DROP TABLE IF EXISTS cliente; CREATE TABLE cliente ( id INT AUTO_INCREMENT PRIMARY KEY, nome VARCHAR(100) NOT NULL, dataAniversario DATE NOT NULL );";

                    using (MySqlCommand cmd = new MySqlCommand(dml, cn))
                    {
                        cmd.CommandType = CommandType.Text;
                        cmd.ExecuteNonQuery();
                    }

                    string sql = @"INSERT INTO cliente( nome, dataAniversario ) VALUES( @nome, @dataAniversario )";

                    using (MySqlCommand cmd = new MySqlCommand(sql, cn))
                    {
                        cmd.CommandType = CommandType.Text;

                        cmd.Parameters.AddWithValue("@nome", "Cecilia Meireles");
                        cmd.Parameters.AddWithValue("@dataAniversario", "1966-10-17");

                        rowsAffected = cmd.ExecuteNonQuery();
                    }
                }
            }
            catch (Exception ex)
            {

                throw new Exception("Ocorreu o seguinte erro: " + ex.ToString());
            }

            return rowsAffected;
        }

        . ExecuteNonQuery - Não retorna dados de consulta, mas retorna o número de linhas afetadas em UPDATE, INSERT e DELETE 
            (para os demais retornará -1), é utilizado geralmente para fazer Inserts, Updates e Deletes. Use para inserir, atualizar
            e apagar dados do banco de dados.

    . Implemente a linha abaixo na classe "Program.cs":

        using AdoNet;

        ConnectionModel cm = new ConnectionModel();

        // Apague a linha abaixo
        // string version = cm.GetClientesCountScala();

        // Insira a linha abaixo
        var rowsAffected = cm.InsertCliente();

    . Execute o projeto


    . Crie a procedure abaixo numa pasta do disco

        DELIMITER $$

        DROP PROCEDURE IF EXISTS spUpdateCliente $$

        CREATE PROCEDURE spUpdateCliente( IN prId INT, IN prNome VARCHAR(100), IN prDataAniversario DATE)
        BEGIN
            UPDATE cliente
            SET Nome = prNome,
                DataAniversario = prDataAniversario
            WHERE Id = prId;

        END $$

        DELIMITER ;

    . Execute o comando abaixo no prompt do sistema operacional:

        docker cp "d:\temp\spUpdateCliente.sql" adoNetSystemDb:/tmp/spUpdateCliente.sql

    . Acesse o banco de dados e compile a procedure

        docker exec -it adoNetSystemDb mysql -u root -p

        use adoNetSystem;

        SOURCE /tmp/spUpdateCliente.sql

        # Comandos interessantes do MySQL para verificar se a procedure foi criada com sucesso
        SHOW PROCEDURE STATUS WHERE Db = DATABASE() AND Name = 'spUpdateCliente'; -- Lista todas as procedures do database

        SHOW CREATE PROCEDURE spUpdateCliente;  -- Lista o corpo da procedure

    . Crie o método abaixo no arquivo "ConnectionModel":

        ...
        public void UpdateClienteStoredProcedure()
        {
            using (MySqlConnection cn = new MySqlConnection(@"server=localhost;userid=root;password=root;database=adoNetSystem"))
            {
                cn.Open();

                using (MySqlCommand cmd = new MySqlCommand("spUpdateCliente", cn))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    cmd.Parameters.Add("@prNome", MySqlDbType.VarChar, 100).Value = "MARCOS SILVA";
                    cmd.Parameters.Add("@prDataAniversario", MySqlDbType.Date).Value = "1985-05-20";
                    cmd.Parameters.Add("@prId", MySqlDbType.Int64).Value = 1;

                    /*
                    MySqlParameter output = new MySqlParameter("@IdGerado", SqlDbType.Int)
                    {
                        Direction = ParameterDirection.Output
                    };
                    cmd.Parameters.Add(output);
                    */

                    cmd.ExecuteNonQuery();

                    // int id = (int)cmd.Parameters["@IdGerado"].Value;
                }
            }
        }

    . Altere as linhas abaixo na classe "Program":

        using AdoNet;

        ConnectionModel cm = new ConnectionModel();

        // string version = cm.GetClientesCountScala();
        // var rowsAffected = cm.InsertCliente();

        // Insira a linha abaixo
        cm.UpdateClienteStoredProcedure();

    . Execute o projeto


. Parâemtros

    . Os parâmetros também podem ser enviados da seguinte forma:

        cmd.Parameters.Add( new MySqlParameter("@nome", "Jose Saramago"));
        cmd.Parameters.Add( new MySqlParameter("@dataAniversario", "2010-10-17"));

        ou

        cmd.Parameters.Add( new MySqlParameter( parameterName : "@dataAniversario", value: "2010-10-17"));

    . Veja mais opções de declarar "Parameters" no link https://csharp.hotexamples.com/pt/examples/-/MySqlDbType/-/php-mysqldbtype-class-examples.html

        . Altere o Program.cs para efetuar a chamada do método acima:

            using AdoNetSystem;

            using ( ConnectionModel connectionModel = new ConnectionModel()){
                connectionModel.InsertCliente();
            }

        . Execute o projeto e veja o resultado.




. Using OUTPUT Parameters

    . Acesse o arquivo Program.cs e substitua o código abaixo:

        using System;
        using MySql.Data.MySqlClient;

        string cs = @"server=localhost;userid=marco;password=brasil2;database=desenv";

        using var con = new MySqlConnection(cs);

        con.Open();

        var stm = "SELECT * FROM cliente";
        var cmd = new MySqlCommand(stm, con);

        using MySqlDataReader rdr = cmd.ExecuteReader();

        while (rdr.Read())
        {
            Console.WriteLine("{0} {1} ", rdr.GetInt32(0), rdr.GetString(1));
        }

        Console.WriteLine($"MySQL version : {con.ServerVersion}");

    . Substitua o código do arquivo Programa.cs pelo código abaixo:

        using System;
        using MySql.Data.MySqlClient;

        string cs = @"server=localhost;userid=marco;password=brasil2;database=desenv";

        using var con = new MySqlConnection(cs);

        con.Open();

        var cmd = con.CreateCommand();
        var stm = @"SELECT * FROM cliente WHERE nome LIKE '%DA%'";

        cmd.CommandText = stm;

        var rdr = cmd.ExecuteReader();

        while (rdr.Read())
        {
            Console.WriteLine("{0} {1} ", rdr.GetInt32(0), rdr.GetString(1));
        }

        Console.WriteLine($"MySQL version : {con.ServerVersion}");



 