Curso Fullstack Angular e Spring (Angular, REST e Spring Boot) - Algaworks
--------------------------------------------------------------------------


Aula 03.01. Criando o projeto da API
------------------------------------

. Crie um projeto spring boot com as seguintes configurações:

    Name : Algamoney-api
    Group : com.algaworks.algamoney-api
    Artefact : algamoney-api
    Package : com.example.algamoney-api

. Nas dependências, adicione as seguintes bibliotecas:

    Devtools
    JPA
    Web
    MySQL / h2 / PostGres


Aula 03.02. Conectando ao MySQL
-------------------------------

. Acesse o arquivo application.properties e insira o código abaixo dependendo do banco que for ser utilizado:

    # ===============================
    # = data.sql file will be executed?
    # ===============================
    spring.datasource.initialization-mode=always

    # Far� somente os update das diferen�as entre as classes model com o BD
    spring.jpa.hibernate.ddl-auto=update

    spring.jpa.show-sql=true

    # Conectando com o MySQL
    ########################
    spring.jpa.database=MYSQL
    spring.datasource.url=jdbc:mysql://localhost/algamoneyapi?createDatabaseIfNotExist=true&useSSL=false
    spring.database.username=root
    spring.database.password=root


    # Connection com o POSTGRES
    ###########################
    #spring.datasource.platform=postgres
    #spring.datasource.url=jdbc:postgresql://localhost:5432/desenv
    #spring.datasource.username=supervisor
    #spring.datasource.password=brasil2




    # Conexão com o H2
    ##################
    spring.datasource.driverClassName=org.h2.Driver
    spring.datasource.username=sa
    spring.datasource.password=
    spring.jpa.database-platform=org.hibernate.dialect.H2Dialect

    #Enabled H2 COnsole
    spring.h2.console.enabled=true

    # Custom H2 Console URL
    spring.h2.console.path=/h2
    # temporary data storage
    spring.datasource.url = jdbc:h2:mem:testdb;DB_CLOSE_ON_EXIT=FALSE

. Execute a aplicação para ver se ela levanta.

. Acesse o link http://localhost:8080/h2 com user "sa" sem senha e veja se as tabelas foram criadas com sucesso


Aula 03.03. Criando a estrutura das tabelas
-------------------------------------------

. Dentro da pasta resources crie o arquivo schema.sql com o conteúdo abaixo:

    CREATE TABLE categoria( codigo SERIAL NOT NULL PRIMARY KEY,
                            nome VARCHAR(50) NOT NULL );

. Dentro da pasta resources crie o arquivo data.sql com o conteúdo abaixo:

    INSERT INTO categoria( nome ) VALUES('Lazer');
    INSERT INTO categoria( nome ) VALUES('Alimentação');
    INSERT INTO categoria( nome ) VALUES('Supermercado');
    INSERT INTO categoria( nome ) VALUES('Farmácia');
    INSERT INTO categoria( nome ) VALUES('Cultura');
    INSERT INTO categoria( nome ) VALUES('Outros');

    

Aula 03.04. Consultando primeiro recurso com GET
------------------------------------------------

. Crie a classe model abaixo:

package com.example.algamoneyapi.model;

import java.io.Serializable;

import javax.persistence.Column;
import javax.persistence.Entity;
import javax.persistence.GeneratedValue;
import javax.persistence.GenerationType;
import javax.persistence.Id;
import javax.persistence.Table;

@Entity
@Table
public class Categoria implements Serializable {

	private static final long serialVersionUID = 1L;

	@Id
	@GeneratedValue( strategy=GenerationType.IDENTITY)
	private Long codigo;
	
	@Column
	private String nome;

	public Long getCodigo() {
		return codigo;
	}

	public void setCodigo(Long codigo) {
		this.codigo = codigo;
	}

	public String getNome() {
		return nome;
	}

	public void setNome(String nome) {
		this.nome = nome;
	}

	@Override
	public String toString() {
		return "Categoria [codigo=" + codigo + ", nome=" + nome + "]";
	}

	@Override
	public int hashCode() {
		final int prime = 31;
		int result = 1;
		result = prime * result + ((codigo == null) ? 0 : codigo.hashCode());
		return result;
	}

	@Override
	public boolean equals(Object obj) {
		if (this == obj)
			return true;
		if (obj == null)
			return false;
		if (getClass() != obj.getClass())
			return false;
		Categoria other = (Categoria) obj;
		if (codigo == null) {
			if (other.codigo != null)
				return false;
		} else if (!codigo.equals(other.codigo))
			return false;
		return true;
	}

	public Categoria(String nome) {
		super();
		this.nome = nome;
	}

	public Categoria() {
		super();
	}
}


. Crie a interface Repository abaixo:

    package com.example.algamoneyapi.repository;

    import org.springframework.data.jpa.repository.JpaRepository;
    import org.springframework.stereotype.Repository;

    import com.example.algamoneyapi.model.Categoria;

    @Repository("categoriaRepository")
    public interface CategoriaRepository extends JpaRepository<Categoria, Long> {

    }

. Crie a classe Resource abaixo:

    package com.example.algamoneyapi.resource;

    import java.util.List;
    import java.util.Optional;

    import org.springframework.beans.factory.annotation.Autowired;
    import org.springframework.web.bind.annotation.GetMapping;
    import org.springframework.web.bind.annotation.PathVariable;
    import org.springframework.web.bind.annotation.RequestMapping;
    import org.springframework.web.bind.annotation.RestController;

    import com.example.algamoneyapi.model.Categoria;
    import com.example.algamoneyapi.repository.CategoriaRepository;

    @RestController
    @RequestMapping("categoria/api")
    public class CategoriaResource {

        @Autowired
        private CategoriaRepository categoriaRepository;
        
        @GetMapping
        public List<Categoria> findAll(){
            
            return categoriaRepository.findAll();
        }
        
        @GetMapping(path= "{codigo}")
        public Optional<Categoria> findById( @PathVariable Long codigo ) {
            
            return categoriaRepository.findById(codigo);
            
            
        }
    }

. Testar os metodos da API:

    . Acesse o Postman;

    . Crie e Teste as URLs abaixo:

        Method : GET
        URL : http://localhost:8080/categoria/api/

        Method : GET
        URL : http://localhost:8080/categoria/api/1

    . Vá em Collection, crie uma coleção de urls e selecione as URLs acima para a Collection criada;
    


Aula 3.6. Cadastrando nova categoria com POST
---------------------------------------------

    . Insira o método abaixo na classe CategoriaResource:

            @PostMapping
            // De forma simples podemos utilizar a annotation abaixo para retornar o código de Status
            // para o Client que retornará 201 Created se tudo der certo. Caso contrário podemos retornar
            // fazer de forma mais detalhada com ResponseEntity, informando detalhes para o Body.Pretty e
            // Headers.Location
            // @ResponseStatus( HttpStatus.CREATED)     
            public ResponseEntity<Categoria> insert(@RequestBody Categoria categoria, 
                                HttpServletResponse response) {
                Categoria categoriaSalva = categoriaRepository.save(categoria);
                
                // Para montar a URL da categoria criada
                //
                // ServletUriComponentsBuilder.fromCurrentRequestUri() -> Retorna a requisição atual
                // .path("/{codigo}").buildAndExpand(categoriaSalva.getCodigo()).toUri() -> Adiciona o código 
                URI uri = ServletUriComponentsBuilder.fromCurrentRequestUri().path("/{codigo}")
                            .buildAndExpand(categoriaSalva.getCodigo()).toUri();


                // Adiciona a URL no header na resposta da requisição
                response.setHeader("Location", uri.toASCIIString());
                
                return ResponseEntity.created(uri).body(categoriaSalva);
            }

    . O @RequestBody, ou corpo da requisição, é onde geralmente enviamos dados que queremos gravar no servidor. 
        Não é muito utilizado em requisições do tipo GET, mas sim nas do tipo POST e PUT. É no corpo da 
        requisição onde você envia dados de um formulário de cadastro em seu site

    . Teste o metodo da API Post:

        . Crie e Teste a URL abaixo:

            Method : POST
            URL : http://localhost:8080/categoria/api/
            Body.raw : { "nome" : "Impostos" }
            Body.JSON

        . Na resposta do method POST, no Postman, verifique o resultado Body.Pretty e Headers.Location


        . adicione o Method POST na Collection de URLs. 



Aula 03.07. Desafio Retornar 404 caso não exista a categoria
------------------------------------------------------------

    . Atualize o metodo findById pelo abaixo:

        @GetMapping(path = "{codigo}")
        public ResponseEntity<?> findById(@PathVariable Long codigo, HttpServletResponse response) {
            try {
                Categoria categoria = categoriaRepository.findById(codigo).orElseThrow( () -> new Exception("Categoria Inexistente")  );

                URI uri = ServletUriComponentsBuilder.fromCurrentRequestUri().path("")
                        .buildAndExpand(categoria.getCodigo()).toUri();

                response.setHeader("Location", uri.toASCIIString());

                return ResponseEntity.ok(categoria);
            } catch (Exception e) {
                return ResponseEntity.badRequest().body(e.getMessage());
            }
        }

    . Atualize o metodo findAll pelo abaixo:

        @GetMapping
        public  ResponseEntity<?> findAll() {

            List<Categoria> categorias = null;

            try {
                categorias = categoriaRepository.findAll();

                return ResponseEntity.ok(categorias);
            } catch (Exception e) {
                return ResponseEntity.badRequest().body(e.getMessage());
            }

        }

    . Observe a tratativa dentro do try...catch. Mudamos o tipo do retorno do metodo para utilizar o retorno com ResponseEntity.
        Aproveitamos para atualizar o header da resposta atraves do objeto response. Na página web, nas infs da header, podemos
        encontrar a URL restful para poder acessar a informação localizada, na "Location".



Aula 03.08. Validando atributos desconhecidos
---------------------------------------------

    . Se quisermos obrigar que toda desserialização dos parâmetros seja obrigatoriamente igual ao que estamos recebendo nos método, 
        utilizaremos a claúsula abaixo no arquivo application.properties. Se isto for usado, sempre que vier um propriedade/parâmetro
        a mais, ou a menos, uma exceção será levantada.

        spring.jackson.deserialization.fail-on-unknown-properties=true

        Exemplo:

            No Client

                { "codigo" : 10,
                    "nome" : "Imposto",
                    "observacao" : "Imposto"
                }

            No Server

                public ResponseEntity<Categoria> insert(@RequestBody Categoria categoria, 
                                                HttpServletResponse response) {
                    ...
                }

                // Uma exceção será levantada por conta da nova informação "observacao"

    . StatusCode

        2xx -> Sucesso
        4xx -> Erro do cliente
        5xx -> Erro no serviço/servidor


Aula 03.09. Tratando erros com ExceptionHandler
-----------------------------------------------

    . Considerando que iremos recusar parâmetros que não se enquadram na estrutura da classe categoria, onde irá levantar exception caso a 
        estrutura do parâmetro não coincida com a estrutura da classe. Trabalharemos com classe de exceção.

    . Crie na pasta src/main/resources o arquivo messages.properties com o conteúdo abaixo:

        mensagem.invalida=Mensagem Invalida


    . Crie a classe abaixo:

        package com.example.algamoneyapi.resource.com.example.algamoneyapi.exceptionhandler;

        import org.springframework.beans.factory.annotation.Autowired;
        import org.springframework.context.MessageSource;
        import org.springframework.context.i18n.LocaleContextHolder;
        import org.springframework.http.HttpHeaders;
        import org.springframework.http.HttpStatus;
        import org.springframework.http.ResponseEntity;
        import org.springframework.http.converter.HttpMessageNotReadableException;
        import org.springframework.web.bind.annotation.ControllerAdvice;
        import org.springframework.web.context.request.WebRequest;
        import org.springframework.web.servlet.NoHandlerFoundException;
        import org.springframework.web.servlet.mvc.method.annotation.ResponseEntityExceptionHandler;

        import java.util.Arrays;
        import java.util.List;
        import java.util.Optional;

        @ControllerAdvice
        public class AlgamoneyExceptionHandler extends ResponseEntityExceptionHandler {

            @Autowired
            private MessageSource messageSource;

            @Override
            protected ResponseEntity<Object> handleHttpMessageNotReadable(HttpMessageNotReadableException ex,
                                                                        HttpHeaders headers, HttpStatus status, WebRequest request) {
                // TODO Auto-generated method stub

                String mensagemUsuario = messageSource.getMessage("mensagem.invalida", null, LocaleContextHolder.getLocale());
                // String mensagemDesenvolvedor = ex.getCause() != null ? ex.getCause().toString() : ex.toString();
                String mensagemDesenvolvedor = Optional.ofNullable(ex.getCause()).orElse(ex).toString();

                List<Erro> erros = Arrays.asList(new Erro(mensagemUsuario, mensagemDesenvolvedor) );

                return handleExceptionInternal(ex, erros, headers, HttpStatus.BAD_REQUEST, request);
            }

            @Override
            protected ResponseEntity<Object> handleNoHandlerFoundException(NoHandlerFoundException ex, HttpHeaders headers,
                                                                        HttpStatus status, WebRequest request) {
                // TODO Auto-generated method stub
                return handleExceptionInternal(ex, "Informação não encontrada!!!", headers, HttpStatus.BAD_REQUEST, request);
            }

            public static class Erro{
                private String mensagemUsuario;
                private String mensagemDesenvolvedor;

                public Erro(String mensagemUsuario, String mensagemDesenvolvedor) {
                    this.mensagemUsuario = mensagemUsuario;
                    this.mensagemDesenvolvedor = mensagemDesenvolvedor;
                }

                public String getMensagemUsuario() {
                    return mensagemUsuario;
                }

                public void setMensagemUsuario(String mensagemUsuario) {
                    this.mensagemUsuario = mensagemUsuario;
                }

                public String getMensagemDesenvolvedor() {
                    return mensagemDesenvolvedor;
                }

                public void setMensagemDesenvolvedor(String mensagemDesenvolvedor) {
                    this.mensagemDesenvolvedor = mensagemDesenvolvedor;
                }
            }

        }


    . Faça o teste no Postman com os parâmetros abaixo:

        Method : POST
        URL : http://localhost:8080/categoria/api/

        // Configure o tipo do parâmetro como JSON
        Body.raw :

            { "codigo" : 10,
                "nome" : "Imposto",
                "observacao" : "Imposto"
            }


Aula 03.10. Validando valores inválidos com Bean Validation
-----------------------------------------------------------

    . Como estamos utilizando o Spring 2.x.x. é necessário colocar no pom.xml a dependência abaixo:

 		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-validation</artifactId>
		</dependency>


    Forma Simples de implementar o Bean Validation:
    -----------------------------------------------

        . Na classe model Categoria adicione as annotation de validação como abaixo:

            @Column
            @NotNull( message="Valor não pode ser nulo")
            @Max(value=50, message="Valor máximo permitido 50 caracteres")
            private String nome;

        . Na classe resource CategoriaResource atualize o metodo POST pelo código abaixo:

            @PostMapping
            public ResponseEntity<?> insert( @Valid @RequestBody Categoria categoria, BindingResult result ) {
                
                if ( result.hasErrors() ) { 
                    Map<String, String> errors = new HashMap<>();
                 
                    for ( FieldError error : result.getFieldErrors()) { 
                        errors.put( error.getField(), error.getDefaultMessage()); 
                    }
                
                    return ResponseEntity.unprocessableEntity().body(errors); 
                }

                try {
                    Categoria categoriaSalva = categoriaRepository.save(categoria);
                } catch (Exception e) {
                    return ResponseEntity.badRequest().body(e.getMessage());
                }
            }

        . Existe uma desvantagem nessa abordagem. Na assinatura do método não temos como utilizar como parâmetro
            o objeto HttpServletResponse response, sem isso não conseguimos montar o cabeçalho de resposta para o 
            cliente.

        . A annotation @Valid força a validação diretamente na assinatura do método.

    Forma mais completa de implementar o Bean Validation com ExceptionHandle:
    -------------------------------------------------------------------------

        . Na classe model Categoria adicione as annotation de validação como abaixo:

            @Column
            @NotNull
            @Size(min=4, max=50, message="Valor deverá ter o tamanho entre 4 e 50 caracteres")
            private String nome;

        . Podemos configurar as mensagens de erro de duas formas. A primeira colocando a mensagem
            como parâmetro da annotation @...(message="mensagem"); a segunda utilizando arquivos de 
            propriedades "properties". Detalhe, elas podem trabalhar em conjunto.

        . Altere o método POST da classe Resource como abaixo:

            @PostMapping
            public ResponseEntity<?> insert( @Valid @RequestBody Categoria categoria, HttpServletResponse response ) {
                try {
                    Categoria categoriaSalva = categoriaRepository.save(categoria);

                    URI uri = ServletUriComponentsBuilder.fromCurrentRequestUri().path("/{codigo}")
                            .buildAndExpand(categoriaSalva.getCodigo()).toUri();

                    response.setHeader("Location", uri.toASCIIString());

                    return ResponseEntity.created(uri).body(categoriaSalva);
                } catch (Exception e) {
                    // TODO Auto-generated catch block
                    return ResponseEntity.badRequest().body(e.getMessage());
                }

            }

        . Só com a implementação acima podemos realizar testes de validação da API. Faça o teste no Postman com os 
            parâmetros abaixo:

            Method : POST
            URL : http://localhost:8080/categoria/api/

            // Configure o tipo do parâmetro como JSON
            Body.raw :

                { 
                    "nome" : null
                }

        . Já dessa forma o StatusCode retorna para a aplicação será 400.

        . Dentro do pacote resources crie o arquivo de propriedades abaixo com o nome message.properties:

            mensagem.invalida=Mensagem inv\u00E1lida

            categoria.nome=Nome        

        . Implemente os métodos e a inner class abaixo na classe ExceptionHandle:

            @ControllerAdvice
            public class AlgamoneyExceptionHandler extends ResponseEntityExceptionHandler {

                // A annotation abaixo injeta a referência do arquivo message.properties
                @Autowired
                private MessageSource messageSource;

                ...
                
                @Override
                protected ResponseEntity<Object> handleMethodArgumentNotValid(MethodArgumentNotValidException ex,
                        HttpHeaders headers, HttpStatus status, WebRequest request) {
                    // TODO Auto-generated method stub
                    List<Erro> erros = criarListaErro(ex.getBindingResult());
                    
                    return handleExceptionInternal(ex, erros, headers, HttpStatus.BAD_REQUEST, request);
                }
                
                
                private List<Erro> criarListaErro( BindingResult bindingResult){
                    
                    List<Erro> erros = new ArrayList<>();
                    
                    for( FieldError fieldError : bindingResult.getFieldErrors() ) {
                        String mensagemUsuario = messageSource.getMessage(fieldError, LocaleContextHolder.getLocale());
                        String mensagemDesenvolvedor =  fieldError.toString();
                        
                        erros.add(new Erro(mensagemUsuario, mensagemDesenvolvedor));
                    }
                    
                    return erros;
                }

                public static class Erro {
                    
                    private String mensagemUsuario;
                    private String mensagemDesenvolvedor;
                    
                    public Erro( String mensagemUsuario, String mensagemDesenvolvedor ) {
                        
                        this.mensagemUsuario = mensagemUsuario;
                        this.mensagemDesenvolvedor = mensagemDesenvolvedor;
                    }

                    public String getMensagemUsuario() {
                        return mensagemUsuario;
                    }

                    public void setMensagemUsuario(String mensagemUsuario) {
                        this.mensagemUsuario = mensagemUsuario;
                    }

                    public String getMensagemDesenvolvedor() {
                        return mensagemDesenvolvedor;
                    }

                    public void setMensagemDesenvolvedor(String mensagemDesenvolvedor) {
                        this.mensagemDesenvolvedor = mensagemDesenvolvedor;
                    }
                    
                }
            }

        . Sempre que houver uma exceção de validação, o método handleMethodArgumentNotValid será executado. 
            Observe no método criarListaErro 

        . Para deixar as mensagens mais amigáveis crie o arquivo ValidationMessages.properties dentro da pasta resource.
            Este arquivo tem que seguir esse padrão de nomenclatura para ser reconhecido automaticamente dentro da classe
            ExceptionHandler.

            javax.validation.constraints.NotNull.message={0} \u00e9 obrigat\u00f3rio(a)
            #javax.validation.constraints.Size.message={0} deve ter o tamanho entre {min} e {max}

        . Para encontrar as chaves desse arquivo basta clicar em cima da annotation de validação (@NotNull, @Size, ...) com
            com Ctrl+Clique do mouse que será apresentado o fonte da annotation e lá dentro apresenta a chave, por exemplo:

            String message() default "{javax.validation.constraints.NotNull.message}";  // Retirado da annotation @NotNull

        . Esse recurso é vantanjoso porque acaba configurando uma mensagem padrão para todas as annotation feita dentro da classe
            Model. 

        . No arquivo ValidationMessages.properties foi configurado a chave e valor 
            "javax.validation.constraints.NotNull.message={0} \u00e9 obrigat\u00f3rio(a)". O conteúdo {0} e o parâmetro que será o 
            nome da propriedade que está levantando a exceção. Por exemplo: se a propriedade nome da categoria levantar exceção a 
            mensagem que aparecerá será "nome é obrigatorio". 

        . Veja que na mensagem produzida a mensagem ficou com nome em letra miniscula. Se quisermos deixar mais amigável ainda coloque o 
            conteúdo abaixo no arquivo messages.properties:

            categoria.nome=Nome

        . Isto fará a mensagem sair "Nome é obrigatorio".

        
Aula 03.12. Usando eventos para adicionar header Location
--------------------------------------------------------

. Criar as classes de evento e de listener abaixo:

    package com.example.algamoneyapi.event;

    import javax.servlet.http.HttpServletResponse;

    import org.springframework.context.ApplicationEvent;

    public class RecursoCriadoEvent<T,K> extends ApplicationEvent {

        /**
        * 
        */
        private static final long serialVersionUID = 1L;

        private HttpServletResponse response;
        private K codigo;
        
        public RecursoCriadoEvent(Object source, HttpServletResponse response, K codigo) {
            super(source);

            this.response = response;
            this.codigo = codigo;
        }

        public HttpServletResponse getResponse() {
            return response;
        }

        public K getCodigo() {
            return codigo;
        }

        
        
    }


    package com.example.algamoneyapi.event.listener;

    import java.net.URI;

    import javax.servlet.http.HttpServletResponse;

    import org.springframework.context.ApplicationListener;
    import org.springframework.stereotype.Component;
    import org.springframework.web.servlet.support.ServletUriComponentsBuilder;

    import com.example.algamoneyapi.event.RecursoCriadoEvent;

    @Component
    public class RecursoCriadoListener implements ApplicationListener<RecursoCriadoEvent>{

        @Override
        public void onApplicationEvent(RecursoCriadoEvent event) {

            HttpServletResponse response = event.getResponse();
            Object codigo = event.getCodigo();
            
            URI uri = ServletUriComponentsBuilder.fromCurrentRequestUri().path("/{codigo}")
                    .buildAndExpand(codigo).toUri();

            response.setHeader("Location", uri.toASCIIString());		
            
        }

    }

. Implemente a propriedade abaixo na classe PessoaResource:

	@Autowired
	private ApplicationEventPublisher publisher;

. Alterar o metodo POST:

    . De

        @PostMapping
        public ResponseEntity<?> insert( @Valid @RequestBody Pessoa pessoa, HttpServletResponse response ) {
            try {
                Pessoa pessoaSalva = pessoaRepository.save(pessoa);

                URI uri = ServletUriComponentsBuilder.fromCurrentRequestUri().path("/{codigo}")
                        .buildAndExpand(pessoaSalva.getCodigo()).toUri();

                response.setHeader("Location", uri.toASCIIString());

                return ResponseEntity.created(uri).body(pessoaSalva);
            } catch (Exception e) {
                // TODO Auto-generated catch block
                return ResponseEntity.badRequest().body(e.getMessage());
            }

        }

    . Para

        @PostMapping
        public ResponseEntity<?> insert( @Valid @RequestBody Pessoa pessoa, HttpServletResponse response ) {
            try {
                Pessoa pessoaSalva = pessoaRepository.save(pessoa);

                publisher.publishEvent( new RecursoCriadoEvent<Pessoa, Long>( this, response, pessoaSalva.getCodigo()));
                
                return ResponseEntity.status(HttpStatus.CREATED).body(pessoaSalva);
            } catch (Exception e) {
                return ResponseEntity.badRequest().body(e.getMessage());
            }
        }


Aula 04.01. Removendo pessoa com DELETE
---------------------------------------

    . Inclua o método abaixo na classe PessoaResource

        @DeleteMapping("{codigo}")
        @ResponseStatus(HttpStatus.NO_CONTENT)
        public void remove( @PathVariable Long codigo) {
            pessoaRepository.deleteById(codigo);
        }

    . Inclua o método abaixo na classe AlgamoneyExceptionHandler:

            @ExceptionHandler(EmptyResultDataAccessException.class)
        //	@ResponseStatus(HttpStatus.NOT_FOUND)
            public ResponseEntity<?> handleEmptyResultDataAccessException(EmptyResultDataAccessException ex, WebRequest request) {
                List<Erro> erros = new ArrayList<>();
                
                String mensagemUsuario = ex.getMessage();
                String mensagemDesenvolvedor =  ex.getMessage().toString();
                
                erros.add(new Erro(mensagemUsuario, mensagemDesenvolvedor));
                
                return handleExceptionInternal(ex, erros, new HttpHeaders(), HttpStatus.NOT_FOUND, request);
            }

    . O método acima não faz parte da implementação padrão da interface ResponseEntityExceptionHandler que a classe AlgamoneyExceptionHandler implementa.
        Sempre que quisermos incluir um método próprio podemos faze-lo através da exceção a ser levantada pela API, neste caso utilizamos a annotation
        @ExceptionHandler informando como parâmetro a classe de exception que deverá ser trabalhada.

    . Se deixarmos o @ResponseStatus( HttpStatus.NOT_FOUND ) não precisaremos colocar mais nenhum código dentro do método. O código dentro do método é 
        somente para enviar uma mensagem ao client.


Aula 4.3. Atualizando pessoa com PUT
------------------------------------

    . Inclua a propriedade abaixo na classe PessoaResource:

        @Autowired
        private CategoriaService categoriaService;

    . Inclua o método abaixo na classe PessoaResource:

        @PutMapping("{codigo}")
        public ResponseEntity<?> update( @PathVariable Long codigo, @Valid @RequestBody Pessoa pessoa  ) {
            Pessoa pessoaSalva = pessoaService.update(codigo, pessoa);
            
            return ResponseEntity.ok(pessoaSalva);
        }

    . Inclua a classe abaixo:

        package com.example.algamoneyapi.service;

        import org.springframework.beans.BeanUtils;
        import org.springframework.beans.factory.annotation.Autowired;
        import org.springframework.dao.EmptyResultDataAccessException;
        import org.springframework.stereotype.Service;

        import com.example.algamoneyapi.model.Pessoa;
        import com.example.algamoneyapi.repository.PessoaRepository;

        @Service
        public class PessoaService {

            @Autowired
            private PessoaRepository pessoaRepository;
            
            public Pessoa update(Long codigo, Pessoa pessoa) {
                
                Pessoa pessoaSalva = findById( codigo );
                
                // Função que copia as infs dos metodos de uma classe para outra. O último parâmetro são os atributos que 
                //  serão desconsiderados para atualização.
                BeanUtils.copyProperties(pessoa, pessoaSalva, "codigo" );
                
                pessoaRepository.save(pessoaSalva);
                
                return pessoaSalva;
                
                
            }
            
            public Pessoa findById( Long codigo ) {
                
                try {
                    Pessoa pessoaSalva = pessoaRepository.findById( codigo ).get();

                    if (pessoaSalva == null) {
                        throw new EmptyResultDataAccessException(1);
                    }
                    
                    return pessoaSalva;
                }catch ( Exception e ) {
                    throw new EmptyResultDataAccessException(1);
                }
            }
            
            
        }

Aula 4.4. Implementando atualização parcial com PUT
---------------------------------------------------

    . Inclua o método abaixo na classe PessoaResource:

        @PutMapping("{codigo}/ativo")
        @ResponseStatus( HttpStatus.NO_CONTENT)
        public void updateAtivo( @PathVariable Long codigo, @RequestBody Boolean ativo ){
            
            pessoaService.updateAtivo(codigo, ativo);
            
        }

        . Foi criado o path "{codigo}/ativo"

    . Inclua o método abaixo na classe PessoaService:

        public void updateAtivo(Long codigo, Boolean ativo) {
            Pessoa pessoaSalva = findById( codigo );
            
            pessoaSalva.setAtivo(ativo);
            
            pessoaRepository.save(pessoaSalva);
        }
        
    . Para executar o teste do método updateAtivo utilize o teste do Postman com o nome de "UPDATE Parcial pessoa"


Aula 5.1. Criando a migração e entidade de lançamento
-----------------------------------------------------

    . Dentro do arquivo schema.sql implemente os comandos abaixo:

        CREATE TABLE pessoa( 	codigo 		SERIAL NOT NULL PRIMARY KEY,
                                nome 		VARCHAR(50) NOT NULL,
                                ativo 		BOOLEAN DEFAULT TRUE,
                                logradouro 	VARCHAR(100) NOT NULL,
                                numero 		VARCHAR(10) NOT NULL,
                                bairro 		VARCHAR(50),
                                complemento VARCHAR(50),
                                cep 		VARCHAR(9) NOT NULL,
                                cidade 		VARCHAR(100) NOT NULL,
                                estado 		VARCHAR(2) NOT NULL );

        CREATE TABLE lancamento (	codigo SERIAL PRIMARY KEY,
                                    descricao VARCHAR(50) NOT NULL,
                                    data_vencimento DATE NOT NULL,
                                    data_pagamento DATE,
                                    valor DECIMAL(10,2) NOT NULL,
                                    observacao VARCHAR(100),
                                    tipo VARCHAR(20) NOT NULL,
                                    codigo_categoria BIGINT(20) NOT NULL,
                                    codigo_pessoa BIGINT(20) NOT NULL,
                                    FOREIGN KEY (codigo_categoria) REFERENCES categoria(codigo),
                                    FOREIGN KEY (codigo_pessoa) REFERENCES pessoa(codigo));
                                    

						
    . Dentro do arquivo data.sql implemente os comandos abaixo:


        INSERT INTO pessoa (nome, logradouro, numero, complemento, bairro, cep, cidade, estado, ativo) 
        values ('João Silva', 'Rua do Abacaxi', '10', null, 'Brasil', '38.400-12', 'Uberlândia', 'MG', true),
                ('Maria Rita', 'Rua do Sabiá', '110', 'Apto 101', 'Colina', '11.400-12', 'Ribeirão Preto', 'S,', true),
                ('Pedro Santos', 'Rua da Bateria', '23', null, 'Morumbi', '54.212-12', 'Goiânia', 'GO', true),
                ('Ricardo Pereira', 'Rua do Motorista', '123', 'Apto 302', 'Aparecida', '38.400-12', 'Salvad,r', 'BA', true),
                ('Josué Mariano', 'Av Rio Branco', '321', null, 'Jardins', '56.400-12', 'Natal', 'RN', true),
                ('Pedro Barbosa', 'Av Brasil', '100', null, 'Tubalina', '77.400-12', 'Porto Alegre', 'RS', true),
                ('Henrique Medeiros', 'Rua do Sapo', '1120', 'Apto 201', 'Centro', '12.400-12', 'Rio de Janeiro', 'R,', true),
                ('Carlos Santana', 'Rua da Manga', '433', null, 'Centro', '31.400-12', 'Belo Horizonte', 'MG', true),
                ('Leonardo Oliveira', 'Rua do Músico', '566', null, 'Segismundo Pereira', '38.400-00', 'Uberlândia', 'MG', true),
                ('Isabela Martins', 'Rua da Terra', '1233', 'Apto 10', 'Vigilato', '99.400-12', 'Manaus', 'AM', true);

        INSERT INTO lancamento (descricao, data_vencimento, data_pagamento, valor, observacao, tipo, codigo_categoria, codigo_pessoa) 
        values ('Salário mensal', '2017-06-10', null, 6500.00, 'Distribuição de lucros', 'RECEITA', 1, 1),
                ('Bahamas', '2017-02-10', '2017-02-10', 100.32, null, 'DESPESA', 2, 2),
                ('Top Club', '2017-06-10', null, 120, null, 'RECEITA', 3, 3),
                ('CEMIG', '2017-02-10', '2017-02-10', 110.44, 'Geração', 'RECEITA', 3, 4),
                ('DMAE', '2017-06-10', null, 200.30, null, 'DESPESA', 3, 5),
                ('Extra', '2017-03-10', '2017-03-10', 1010.32, null, 'RECEITA', 4, 6),
                ('Bahamas', '2017-06-10', null, 500, null, 'RECEITA', 1, 7),
                ('Top Club', '2017-03-10', '2017-03-10', 400.32, null, 'DESPESA', 4, 8),
                ('Despachante', '2017-06-10', null, 123.64, 'Multas', 'DESPESA', 3, 9),
                ('Pneus', '2017-04-10', '2017-04-10', 665.33, null, 'RECEITA', 5, 10),
                ('Café', '2017-06-10', null, 8.32, null, 'DESPESA', 1, 5),
                ('Eletrônicos', '2017-04-10', '2017-04-10', 2100.32, null, 'DESPESA', 5, 4),
                ('Instrumentos', '2017-06-10', null, 1040.32, null, 'DESPESA', 4, 3),
                ('Café', '2017-04-10', '2017-04-10', 4.32, null, 'DESPESA', 4, 2),
                ('Lanche', '2017-06-10', null, 10.20, null, 'DESPESA', 4, 1);

    . Crie a classe Enum abaixo:

        package com.example.algamoneyapi.model;

        public enum TipoLancamento {

            RECEITA,
            DESPESA
            
        }

    . Crie, ou atualize, o arquivo de propriedades messages.properties dentro do pacote src/main/resources

        mensagem.invalida=Mensagem inv\u00E1lida

        categoria.nome=Nome

        recurso.nao-encontrado=Recurso nao encontrado

        recurso.operacao-nao-permitido=Operacao nao permitida    

    . Crie as classes abaixo:    

        package com.example.algamoneyapi.model;

        import java.math.BigDecimal;
        import java.time.LocalDate;

        import javax.persistence.Column;
        import javax.persistence.Entity;
        import javax.persistence.EnumType;
        import javax.persistence.Enumerated;
        import javax.persistence.FetchType;
        import javax.persistence.GeneratedValue;
        import javax.persistence.GenerationType;
        import javax.persistence.Id;
        import javax.persistence.JoinColumn;
        import javax.persistence.ManyToOne;
        import javax.validation.constraints.Future;
        import javax.validation.constraints.Positive;
        import javax.validation.constraints.Size;

        import org.springframework.format.annotation.DateTimeFormat;
        import org.springframework.format.annotation.DateTimeFormat.ISO;

        @Entity
        public class Lancamento {

            @Id
            @GeneratedValue( strategy = GenerationType.IDENTITY)
            private Long codigo;
            
            @Column
            @NotNull
            @Size( min=4, max=50, message="Conteúdo deve ser entre 4 a 50 dígitos")
            private String descricao;
            
            @DateTimeFormat( iso = ISO.DATE)
            @Future(message="Data inválida. Tem que ser uma data futura")
            @NotNull
            @Column( columnDefinition="DATE", nullable=false)
            private LocalDate dataVencimento;
            
            @DateTimeFormat( iso = ISO.DATE)
            @Column( columnDefinition="DATE", nullable=false)
            private LocalDate dataPagamento;
            
            
            @Column( nullable = false, columnDefinition = "DECIMAL(7,2) DEFAULT 0.00")
            @NotNull
            @Positive
            private BigDecimal valor;
            
            
            @Column
            @Size( max=100 )
            private String observacao;
            
            @Column
            @Enumerated( EnumType.STRING )
            private TipoLancamento tipo;
            
            @ManyToOne(fetch=FetchType.EAGER)
            @JoinColumn( name= "codigo_categoria", nullable=false)
            private Categoria categoria;
            
            @ManyToOne(fetch=FetchType.EAGER)
            @JoinColumn( name="codigo_pessoa", nullable=false)
            private Pessoa pessoa;

            public String getDescricao() {
                return descricao;
            }

            public void setDescricao(String descricao) {
                this.descricao = descricao;
            }

            public LocalDate getDataVencimento() {
                return dataVencimento;
            }

            public void setDataVencimento(LocalDate dataVencimento) {
                this.dataVencimento = dataVencimento;
            }

            public LocalDate getDataPagamento() {
                return dataPagamento;
            }

            public void setDataPagamento(LocalDate dataPagamento) {
                this.dataPagamento = dataPagamento;
            }

            public BigDecimal getValor() {
                return valor;
            }

            public void setValor(BigDecimal valor) {
                this.valor = valor;
            }

            public String getObservacao() {
                return observacao;
            }

            public void setObservacao(String observacao) {
                this.observacao = observacao;
            }

            public TipoLancamento getTipo() {
                return tipo;
            }

            public void setTipo(TipoLancamento tipo) {
                this.tipo = tipo;
            }

            public Categoria getCategoria() {
                return categoria;
            }

            public void setCategoria(Categoria categoria) {
                this.categoria = categoria;
            }

            public Pessoa getPessoa() {
                return pessoa;
            }

            public void setPessoa(Pessoa pessoa) {
                this.pessoa = pessoa;
            }

            public Long getCodigo() {
                return codigo;
            }

            public void setCodigo(Long codigo) {
                this.codigo = codigo;
            }

            public Lancamento(@Size(min = 4, max = 50, message = "Conte�do deve ser entre 4 a 50 d�gitos") String descricao,
                    @Future(message = "Data inv�lida") LocalDate dataVencimento, LocalDate dataPagamento,
                    @Positive BigDecimal valor, @Size(max = 100) String observacao, TipoLancamento tipo, Categoria categoria,
                    Pessoa pessoa) {
                super();
                this.descricao = descricao;
                this.dataVencimento = dataVencimento;
                this.dataPagamento = dataPagamento;
                this.valor = valor;
                this.observacao = observacao;
                this.tipo = tipo;
                this.categoria = categoria;
                this.pessoa = pessoa;
            }

            public Lancamento() {
                super();
            }

            @Override
            public int hashCode() {
                final int prime = 31;
                int result = 1;
                result = prime * result + ((codigo == null) ? 0 : codigo.hashCode());
                return result;
            }

            @Override
            public boolean equals(Object obj) {
                if (this == obj)
                    return true;
                if (obj == null)
                    return false;
                if (getClass() != obj.getClass())
                    return false;
                Lancamento other = (Lancamento) obj;
                if (codigo == null) {
                    if (other.codigo != null)
                        return false;
                } else if (!codigo.equals(other.codigo))
                    return false;
                return true;
            }

            @Override
            public String toString() {
                return "Lancamento [codigo=" + codigo + ", descricao=" + descricao + ", dataVencimento=" + dataVencimento
                        + ", dataPagamento=" + dataPagamento + ", valor=" + valor + ", observacao=" + observacao + ", tipo="
                        + tipo + ", categoria=" + categoria + ", pessoa=" + pessoa + "]";
            }
            
            
            
        }





        package com.example.algamoneyapi.repository;

        import org.springframework.data.jpa.repository.JpaRepository;
        import org.springframework.stereotype.Repository;

        import com.example.algamoneyapi.model.Lancamento;

        @Repository
        public interface LancamentoRepository extends JpaRepository<Lancamento, Long>{

        }






    package com.example.algamoneyapi.service;

    import org.springframework.beans.BeanUtils;
    import org.springframework.beans.factory.annotation.Autowired;
    import org.springframework.dao.EmptyResultDataAccessException;
    import org.springframework.stereotype.Service;

    import com.example.algamoneyapi.model.Lancamento;
    import com.example.algamoneyapi.repository.LancamentoRepository;

    @Service
    public class LancamentoService {
        @Autowired
        private LancamentoRepository LancamentoRepository;
        
        public Lancamento update(Long codigo, Lancamento Lancamento) {
            
            Lancamento LancamentoSalva = findById( codigo );
            
            BeanUtils.copyProperties(Lancamento, LancamentoSalva, "codigo" );
            
            LancamentoRepository.save(LancamentoSalva);
            
            return LancamentoSalva;
            
            
        }
        
        public Lancamento findById( Long codigo ) {
            
            try {
                Lancamento LancamentoSalva = LancamentoRepository.findById( codigo ).get();

                if (LancamentoSalva == null) {
                    throw new EmptyResultDataAccessException(1);
                }
                
                return LancamentoSalva;
            }catch ( Exception e ) {
                throw new EmptyResultDataAccessException(1);
            }
        }
        
        

    }





    package com.example.algamoneyapi.resource;

    import java.util.List;
    import java.util.Optional;

    import javax.servlet.http.HttpServletResponse;
    import javax.validation.Valid;

    import org.springframework.beans.factory.annotation.Autowired;
    import org.springframework.context.ApplicationEventPublisher;
    import org.springframework.dao.EmptyResultDataAccessException;
    import org.springframework.http.HttpStatus;
    import org.springframework.http.ResponseEntity;
    import org.springframework.web.bind.annotation.DeleteMapping;
    import org.springframework.web.bind.annotation.GetMapping;
    import org.springframework.web.bind.annotation.PathVariable;
    import org.springframework.web.bind.annotation.PostMapping;
    import org.springframework.web.bind.annotation.PutMapping;
    import org.springframework.web.bind.annotation.RequestBody;
    import org.springframework.web.bind.annotation.RequestMapping;
    import org.springframework.web.bind.annotation.ResponseStatus;
    import org.springframework.web.bind.annotation.RestController;

    import com.example.algamoneyapi.event.RecursoCriadoEvent;
    import com.example.algamoneyapi.model.Lancamento;
    import com.example.algamoneyapi.repository.LancamentoRepository;
    import com.example.algamoneyapi.service.LancamentoService;

    @RestController
    @RequestMapping("lancamento/api")
    public class LancamentoResource {

        @Autowired
        LancamentoRepository lancamentoRepository;
        
        @Autowired
        LancamentoService lancamentoService;
        
        @Autowired
        ApplicationEventPublisher publisher;
        
        
        @GetMapping
        public ResponseEntity<?> findAll(HttpServletResponse response){
            
            List<Lancamento> lancamentos = null;
            
            try {
                lancamentos = lancamentoRepository.findAll();
                
                publisher.publishEvent( new RecursoCriadoEvent<Lancamento, Long>( this, response, null));

                return ResponseEntity.ok(lancamentos); 
                
            }catch( Exception e ) {
                return ResponseEntity.badRequest().body(e.getMessage());
            }
            
        }
        

        @GetMapping(path="/{codigo}")
        public ResponseEntity<?> findById( @PathVariable Long codigo, HttpServletResponse response ){
            
            
            Optional<Lancamento> lancamento = lancamentoRepository.findById(codigo);
            
            if (lancamento.isPresent()) {
                throw new EmptyResultDataAccessException(1);
            }
            
            publisher.publishEvent(new RecursoCriadoEvent<Lancamento, Long>(this, response,  null));
            
            return ResponseEntity.ok(lancamento);
        }
        
        
        @PostMapping
        public ResponseEntity<?> insert( @Valid @RequestBody Lancamento lancamento, HttpServletResponse response) {
            
            Lancamento lancamentoSalvo = lancamentoRepository.save(lancamento);

            publisher.publishEvent(new RecursoCriadoEvent<Lancamento, Long>(this, response,  null));
            
            return ResponseEntity.status( HttpStatus.CREATED ).body(lancamentoSalvo);
        }
        
        @PutMapping( path="/{codigo}")
        public ResponseEntity<?> update( @PathVariable Long codigo, @Valid @RequestBody Lancamento lancamento){
            
            Lancamento lancamentoSalvo = lancamentoService.update(codigo, lancamento);
            
            return ResponseEntity.ok(lancamentoSalvo);	
        }
        
        @DeleteMapping( path="/{codigo}")
        @ResponseStatus( HttpStatus.NO_CONTENT)
        public void remove( @PathVariable Long codigo ) {
            lancamentoRepository.deleteById(codigo);
        }
        
    }



Aula 5.4. Validando inconsistências
-----------------------------------

    . Crie no pom.xml a dependencia abaixo:

		<dependency>
			<groupId>org.apache.commons</groupId>
			<artifactId>commons-lang3</artifactId>
			<version>3.11</version>
		</dependency>

    . Acrescente no arquivo messages.properties a linha abaixo:

        recurso.operacao-nao-permitido=Problema de integridade entre as informacoes

    . Crie o método abaixo na classe AlgamoneyExceptionHandler:

        @ExceptionHandler(  {DataIntegrityViolationException.class}  )
        public ResponseEntity<Object> handleDataIntegrityViolationException( DataIntegrityViolationException ex, WebRequest request ){
                String mensagemUsuario = messageSource.getMessage("recurso.operacao-nao-permitido", null, LocaleContextHolder.getLocale());
            // String mensagemDesenvolvedor = ex.getCause() != null ? ex.getCause().toString() : ex.toString();
            // String mensagemDesenvolvedor = Optional.ofNullable(ex.getCause()).orElse(ex).toString();
            String mensagemDesenvolvedor = ExceptionUtils.getRootCauseMessage(ex);

            List<Erro> erros = Arrays.asList(new Erro(mensagemUsuario, mensagemDesenvolvedor) );
            
            
            return handleExceptionInternal(ex, erros, new HttpHeaders(), HttpStatus.BAD_REQUEST, request);
            
        }

    . Observe que a mensagemDesenvolvedor foi alterada, agora ela é construida através da classe ExceptionUtils. Esta classe é encontrada no
        pacote commons-lang3, a responsabilidade deste pacote é detalhar melhor a mensagem de erro da exception.

    . Observe também no trecho de código abaixo. "recurso.operacao-nao-permitido" é substituido pelo conteúdo do arquivo messages.properties

        String mensagemUsuario = messageSource.getMessage("recurso.operacao-nao-permitido", null, LocaleContextHolder.getLocale());


Aula 05.06. Regra para não salvar pessoa inativa
------------------------------------------------

    . Crie a classe service abaixo:

        package com.example.algamoneyapi.service;

        import org.springframework.beans.BeanUtils;
        import org.springframework.beans.factory.annotation.Autowired;
        import org.springframework.dao.EmptyResultDataAccessException;
        import org.springframework.stereotype.Service;

        import com.example.algamoneyapi.model.Lancamento;
        import com.example.algamoneyapi.model.Pessoa;
        import com.example.algamoneyapi.repository.LancamentoRepository;
        import com.example.algamoneyapi.repository.PessoaRepository;
        import com.example.algamoneyapi.service.exception.PessoaInexistenteOuInativaException;

        @Service
        public class LancamentoService {
            @Autowired
            private LancamentoRepository lancamentoRepository;
            
            @Autowired
            private PessoaRepository pessoaRepository; 
            
            
            
            public Lancamento update(Long codigo, Lancamento Lancamento) {
                
                Lancamento LancamentoSalva = findById( codigo );
                
                BeanUtils.copyProperties(Lancamento, LancamentoSalva, "codigo" );
                
                lancamentoRepository.save(LancamentoSalva);
                
                return LancamentoSalva;
                
                
            }
            
            public Lancamento findById( Long codigo ) {
                
                try {
                    Lancamento LancamentoSalva = lancamentoRepository.findById( codigo ).get();

                    if (LancamentoSalva == null) {
                        throw new EmptyResultDataAccessException(1);
                    }
                    
                    return LancamentoSalva;
                }catch ( Exception e ) {
                    throw new EmptyResultDataAccessException(1);
                }
            }
            
            
            public Lancamento save( Lancamento lancamento ) {
                
                Pessoa pessoa = pessoaRepository.findById( lancamento.getPessoa().getCodigo() ).get();
                
                if (pessoa == null || pessoa.isInativo() ) {
                    throw new PessoaInexistenteOuInativaException();
                }
                return lancamentoRepository.save(lancamento);
            }
        }

    . Implemente a Exception abaixo:

        package com.example.algamoneyapi.service.exception;

        public class PessoaInexistenteOuInativaException extends RuntimeException {

            private static final long serialVersionUID = 1L;
        }


    . Implemente o código abaixo na classe Model Pessoa:

        @JsonIgnore
        @Transient
        public Boolean isInativo() {
            return !this.ativo;
        }
        
        . A annotation @JsonIgnore servirá para não criar no resultado JSon a informação do método isInativo
        . A annotation @Transient servirá para não persistir a informação

    . Na classe LancamentoResource inclua a declaração abaixo:

        @Autowired
        LancamentoService lancamentoService;

    . Altere o método abaixo da classe LancamentoResource:

        @PostMapping
        public ResponseEntity<?> insert( @Valid @RequestBody Lancamento lancamento, HttpServletResponse response) {

            // Foi alterado de lancamentoRepository.insert para lancamentoService.save para implementar a regra que restringe a inclusão
            // de lançamento de pessoas inativas
            Lancamento lancamentoSalvo = lancamentoService.save(lancamento);

            publisher.publishEvent(new RecursoCriadoEvent<Lancamento, Long>(this, response,  lancamentoSalvo.getCodigo()));
            
            return ResponseEntity.status( HttpStatus.CREATED ).body(lancamentoSalvo);
        }

    . Implemente o método abaixo na classe LancamentoResource:

        @ExceptionHandler( PessoaInexistenteOuInativaException.class )
        public ResponseEntity<?> handlePessoaInexistenteOuInativaException( PessoaInexistenteOuInativaException ex){
            String mensagemUsuario = messageSource.getMessage("pessoa.inexistente-ou-inativa", null, LocaleContextHolder.getLocale());
            // String mensagemDesenvolvedor = ex.getCause() != null ? ex.getCause().toString() : ex.toString();
            String mensagemDesenvolvedor = Optional.ofNullable(ex.getCause()).orElse(ex).toString();
            
            List<Erro> erros = Arrays.asList(new Erro(mensagemUsuario, mensagemDesenvolvedor) );
            
            
            return ResponseEntity.badRequest().body(erros);
            
        }

        . Este método servirá para pegar a Exception levantada pela classe LancamentoService

    . Implemente a linha abaixo no arquivo messages.properties:

        pessoa.inexistente-ou-inativa=Pessoa inexistente ou inativa

    . Faça a inativação de uma das pessoas:

        http://localhost:8080/pessoa/2/ativo 

        . Coloque o parâmetro como false

    . Faça o teste colocando um lançamento com a pessoa 2 que foi inativado.



Aula 5.7. Implementando pesquisa de lançamento com Metamodel
------------------------------------------------------------

    . Crie o método abaixo na classe LancamentoResource

        @GetMapping(path="/filter")
        public List<Lancamento> findByFilter(LancamentoFilter lancamentoFilter){
            
            List<Lancamento> lancamentos = lancamentoRepository.filtrar( lancamentoFilter );
            
            return lancamentos;
            
        }

    . Crie a classe LancamentoFilter como abaixo:

        package com.example.algamoneyapi.resource.filter;


        import java.time.LocalDate;

        import org.springframework.format.annotation.DateTimeFormat;
        import org.springframework.format.annotation.DateTimeFormat.ISO;

        public class LancamentoFilter {

            private String descricao;
            
            @DateTimeFormat(iso = ISO.DATE)
            private LocalDate dataVencimentoDe;
            
            @DateTimeFormat(iso = ISO.DATE)
            private LocalDate dataVencimentoAte;

            public String getDescricao() {
                return descricao;
            }

            public void setDescricao(String descricao) {
                this.descricao = descricao;
            }

            public LocalDate getDataVencimentoDe() {
                return dataVencimentoDe;
            }

            public void setDataVencimentoDe(LocalDate dataVencimentoDe) {
                this.dataVencimentoDe = dataVencimentoDe;
            }

            public LocalDate getDataVencimentoAte() {
                return dataVencimentoAte;
            }

            public void setDataVencimentoAte(LocalDate dataVencimentoAte) {
                this.dataVencimentoAte = dataVencimentoAte;
            }

        }

    . Crie a interface LancamentoRepositoryQuery como abaixo:

        package com.example.algamoneyapi.repository.lancamento;

        import java.util.List;

        import com.example.algamoneyapi.model.Lancamento;
        import com.example.algamoneyapi.resource.filter.LancamentoFilter;


        public interface LancamentoRepositoryQuery {

            public List<Lancamento> filtrar(LancamentoFilter lancamentoFilter);
            
        }


    . Crie a classe LancamentoRepositoryQueryImpl como abaixo:

        package com.example.algamoneyapi.repository.lancamento;

        import java.util.ArrayList;
        import java.util.List;

        import javax.persistence.EntityManager;
        import javax.persistence.PersistenceContext;
        import javax.persistence.TypedQuery;
        import javax.persistence.criteria.CriteriaBuilder;
        import javax.persistence.criteria.CriteriaQuery;
        import javax.persistence.criteria.Predicate;
        import javax.persistence.criteria.Root;

        import org.springframework.util.StringUtils;

        import com.example.algamoneyapi.model.Lancamento;
        import com.example.algamoneyapi.resource.filter.LancamentoFilter;

        public class LancamentoRepositoryImpl implements LancamentoRepositoryQuery {

            @PersistenceContext
            private EntityManager manager;
            
            @Override
            public List<Lancamento> filtrar(LancamentoFilter lancamentoFilter) {
                CriteriaBuilder builder = manager.getCriteriaBuilder();
                CriteriaQuery<Lancamento> criteria = builder.createQuery(Lancamento.class);
                Root<Lancamento> root = criteria.from(Lancamento.class);
                
                Predicate[] predicates = criarRestricoes(lancamentoFilter, builder, root);
                criteria.where(predicates);
                
                TypedQuery<Lancamento> query = manager.createQuery(criteria);
                return query.getResultList();
            }

            private Predicate[] criarRestricoes(LancamentoFilter lancamentoFilter, CriteriaBuilder builder,
                    Root<Lancamento> root) {
                List<Predicate> predicates = new ArrayList<>();
                
                if (!StringUtils.isEmpty(lancamentoFilter.getDescricao())) {
                    predicates.add(builder.like(
                            builder.lower(root.get("descricao")), "%" + lancamentoFilter.getDescricao().toLowerCase() + "%"));
                }
                
                if (lancamentoFilter.getDataVencimentoDe() != null) {
                    predicates.add(
                            builder.greaterThanOrEqualTo(root.get("dataVencimento"), lancamentoFilter.getDataVencimentoDe()));
                }
                
                if (lancamentoFilter.getDataVencimentoAte() != null) {
                    predicates.add(
                            builder.lessThanOrEqualTo(root.get("dataVencimento"), lancamentoFilter.getDataVencimentoAte()));
                }
                
                return predicates.toArray(new Predicate[predicates.size()]);
            }
        }

    . No postman realize os testes com os links GET abaixo:

        http://localhost:8080/lancamento/api/filter?dataVencimentoDe=2017-06-01    
        http://localhost:8080/lancamento/api/filter?dataVencimentoAte=2017-06-01
        http://localhost:8080/lancamento/api/filter?descricao=mensal 


Aula 05.09. Implementando a paginação de lançamentos
----------------------------------------------------

. Dentro da classe LancamentoResource coloque o método abaixo:

	@GetMapping(path="/filterAndPageable")
	public Page<Lancamento> findByFilterAndPageable(LancamentoFilter lancamentoFilter, Pageable pageable){
		
		Page<Lancamento> lancamentos = lancamentoRepository.filtrar( lancamentoFilter, pageable );
		
		return lancamentos;
		
	}

    . Observe que:
        
        O retorno do método é a classe Page<Lancamento>
        Na assinatura do método foi colocado o parâmetro Pageable pageable. No cliente é colocado os valores 
            "page=[No. da página iniciando com a pág 0]" e "size=[No. de regs por pag]"

. Dentro da interface LancamentoFilterQuery coloque o método abaixo:

	public Page<Lancamento> filtrar(LancamentoFilter lancamentoFilter, Pageable pageable);

. Dentro da classe LancamentoFilterQueryImpl coloque os métodos abaixo:

	@Override
	public Page<Lancamento> filtrar(LancamentoFilter lancamentoFilter, Pageable pageable) {
		CriteriaBuilder builder = manager.getCriteriaBuilder();
		CriteriaQuery<Lancamento> criteria = builder.createQuery(Lancamento.class);
		Root<Lancamento> root = criteria.from(Lancamento.class);
		
		Predicate[] predicates = criarRestricoes(lancamentoFilter, builder, root);
		criteria.where(predicates);
		
		TypedQuery<Lancamento> query = manager.createQuery(criteria);
		
		adicionarRestricaoDePaginacao(query, pageable);
		
		Long totalReg = total(lancamentoFilter);
		
		return new PageImpl<>(query.getResultList(), pageable, total(lancamentoFilter));
	}

	private void adicionarRestricaoDePaginacao(TypedQuery<Lancamento> query, Pageable pageable) {
		int paginaAtual = pageable.getPageNumber();
		int totalRegistroPorPagina = pageable.getPageSize();
		int primeiroRegistroDaPagina = paginaAtual * totalRegistroPorPagina;
		
		query.setFirstResult(primeiroRegistroDaPagina);
		query.setMaxResults(totalRegistroPorPagina);
		
		
	}

	private Long total(LancamentoFilter lancamentoFilter) {
		CriteriaBuilder builder = manager.getCriteriaBuilder();
		
		CriteriaQuery<Long> criteria = builder.createQuery(Long.class);
		
		Root<Lancamento> root = criteria.from(Lancamento.class);
		
		Predicate[] predicates = criarRestricoes(lancamentoFilter, builder, root);
		
		criteria.where(predicates);
		
		criteria.select(builder.count(root));
		
		return manager.createQuery(criteria).getSingleResult();
	}

. Teste a página no Postman com a URL abaixo:

    Method : GET
    URL : http://localhost:8080/lancamento/api/filterAndPageable?page=0&size=5&dataVencimentoAte=2017-06-01



Aula 6.1. Implementando autenticação Basic
------------------------------------------

. Acrescente a dependencia abaixo no pom.xml

    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-security</artifactId>
    </dependency>

. Crie a classe abaixo no projeto:

    package com.example.algamoneyapi.config;

    import org.springframework.context.annotation.Configuration;
    import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;
    import org.springframework.security.config.annotation.web.builders.HttpSecurity;
    import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
    import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;
    import org.springframework.security.config.http.SessionCreationPolicy;

    @Configuration
    @EnableWebSecurity
    public class SecurityConfig extends WebSecurityConfigurerAdapter {
        @Override
        protected void configure(AuthenticationManagerBuilder auth) throws Exception {
            auth.inMemoryAuthentication()
                .withUser("admin").password("{noop}admin").roles("ROLE");
        }
        
        @Override
        protected void configure(HttpSecurity http) throws Exception {
            http.authorizeRequests()
                    .antMatchers("/categoria/api/**").permitAll()
                    .antMatchers("/h2/**").permitAll()
                    .antMatchers("/h2-console/**").permitAll()
                    .anyRequest().authenticated().and()
                    .headers().frameOptions().sameOrigin().and()
                    .httpBasic().and()
                    .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS).and()
                    .csrf().ignoringAntMatchers("/h2-console/**").and()
                    .csrf().disable();
        }
        
    }

. Retorne ao Postman e execute os links novamente para ver se a consulta ainda funciona:

    Method : GET
    URL : http://localhost:8080/lancamento/api/filterAndPageable?page=0&size=5&dataVencimentoAte=2017-06-01

    . O objetivo é não funcionar, pois agora existe o controle de autenticação.

. Execute o link das categorias:

    Method : GET
    URL : http://localhost:8080/categoria/api

    Method : GET
    URL : http://localhost:8080/categoria/api/1

    . Os links da categoria tem que funcionar pois tem a permissão para isso na configuração:

        http.authorizeRequests()
                .antMatchers("/categoria/api/**").permitAll()
                .anyRequest().authenticated()
                .and()
            .httpBasic().and()
            .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS).and()
            .csrf().disable();

. Retorne ao Postman, no link do lancamento. Acesse as configurações Authentication; escolha o type "Basic Auth";
    coloque no Username : admin e Password : admin; e acione o botão "Update Request".

    . Na aba Headers observe que foi colocado um parâmetro com o nome de Authorization com um valor

    . Ao enviar o link ainda não conseguiremos retornar o conteúdo porque a senha está errada.

. Altere o usuário e senha para "admin" "admin" e execute novamente o link. Dessa vez haverá retorno das informações.



https://howtodoinjava.com/spring-boot2/security-rest-basic-auth-example/
http://websystique.com/spring-security/secure-spring-rest-api-using-basic-authentication/



. Outra forma mais complexa de definir os acessos seria como abaixo:

    . Altere a classe SecurityConfig como abaixo:


        package com.example.algamoneyapi.config;

        import org.springframework.beans.factory.annotation.Autowired;
        import org.springframework.context.annotation.Bean;
        import org.springframework.context.annotation.Configuration;
        import org.springframework.http.HttpMethod;
        import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;
        import org.springframework.security.config.annotation.web.builders.HttpSecurity;
        import org.springframework.security.config.annotation.web.builders.WebSecurity;
        import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
        import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;
        import org.springframework.security.config.http.SessionCreationPolicy;
        import org.springframework.security.web.AuthenticationEntryPoint;

        @Configuration
        @EnableWebSecurity
        public class SecurityConfig extends WebSecurityConfigurerAdapter {

            private static String REALM = "basic_maransi";

            @Autowired
            public void configureGlobalSecurity(AuthenticationManagerBuilder auth) throws Exception {
                auth.inMemoryAuthentication().withUser("bill").password("{noop}abc123").roles("ADMIN");
                auth.inMemoryAuthentication().withUser("tom").password("{noop}abc123").roles("USER");
                auth.inMemoryAuthentication().withUser("admin").password("{noop}admin").roles("ROLE");
            }

            @Override
            protected void configure(HttpSecurity http) throws Exception {
                
                http.csrf().disable()
                    .authorizeRequests()
                    .antMatchers("/categoria/api/**").permitAll()          // Qq um poderá acessar esse contexto 
                    .antMatchers("/lancamento/**").hasRole("ROLE")      // Somente usuários com esta role poderá acessar esse contexto
                    .antMatchers("/h2/**").permitAll()
                    .antMatchers("/h2-console/**").permitAll()
                    .anyRequest().authenticated().and()
                    .headers().frameOptions().sameOrigin().and()
                    .httpBasic().and()
                    .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS).and()
                    .csrf().ignoringAntMatchers("/h2-console/**").and()
                    .csrf().disable();
            }

            @Bean
            public CustomBasicAuthenticationEntryPoint getBasicAuthEntryPoint() {
                return new CustomBasicAuthenticationEntryPoint();
            }

            /* To allow Pre-flight [OPTIONS] request from browser */
            @Override
            public void configure(WebSecurity web) throws Exception {
                web.ignoring().antMatchers(HttpMethod.OPTIONS, "/**");
            }
        }


    . Crie a classe CustomBasicAuthenticationEntryPoint que será disparada caso a autenticação falhe
        para completar as informações de resposta ao cliente.

        package com.example.algamoneyapi.config;

        import java.io.IOException;
        import java.io.PrintWriter;

        import javax.servlet.ServletException;
        import javax.servlet.http.HttpServletRequest;
        import javax.servlet.http.HttpServletResponse;

        import org.springframework.security.core.AuthenticationException;
        import org.springframework.security.web.authentication.www.BasicAuthenticationEntryPoint;
        
        public class CustomBasicAuthenticationEntryPoint extends BasicAuthenticationEntryPoint {
        
            @Override
            public void commence(final HttpServletRequest request, 
                    final HttpServletResponse response, 
                    final AuthenticationException authException) throws IOException {
                //Authentication failed, send error response.
                response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);
                response.addHeader("WWW-Authenticate", "Basic realm=" + getRealmName() + "");
                
                PrintWriter writer = response.getWriter();
                writer.println("HTTP Status 401 : " + authException.getMessage());
            }
            
            @Override
            public void afterPropertiesSet() {
                setRealmName("basic_maransi");
                super.afterPropertiesSet();
            }
        }    

    . Retorne ao Postman, acesse as configurações Authentication; escolha o type "Basic Auth";
        coloque no Username : tom e Password : abc123; utilize o link abaixo; e acione o botão "Send"

        Method : GET
        URL : http://localhost:8080/lancamento/api/

        . Dará erro, pois esse link só está configurado a liberação para os usuários com a role "ROLE"

    . Execute o mesmo link acima com o usuário admin : admin



Aula 6.3. Implementando segurança com OAuth 2 e Password Flow
-------------------------------------------------------------

. Inclua a dependência abaixo no pom.xml:

		<dependency>
			<groupId>org.springframework.security.oauth</groupId>
			<artifactId>spring-security-oauth2</artifactId>
			<version>2.3.4.RELEASE</version>
		</dependency>

. Apague todas as classes do pacote com.example.algamoneyapi.config .

. Inclua a classe abaixo no projeto:

    package com.example.algamoneyapi.config;

    import org.springframework.beans.factory.annotation.Autowired;
    import org.springframework.context.annotation.Configuration;
    import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;
    import org.springframework.security.config.annotation.web.builders.HttpSecurity;
    import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
    import org.springframework.security.config.http.SessionCreationPolicy;
    import org.springframework.security.oauth2.config.annotation.web.configuration.EnableResourceServer;
    import org.springframework.security.oauth2.config.annotation.web.configuration.ResourceServerConfigurerAdapter;
    import org.springframework.security.oauth2.config.annotation.web.configurers.ResourceServerSecurityConfigurer;

    @Configuration
    @EnableWebSecurity
    @EnableResourceServer
    public class ResourceServerConfig extends ResourceServerConfigurerAdapter {

        @Autowired
        public void configure(AuthenticationManagerBuilder auth) throws Exception {
            auth.inMemoryAuthentication()
                .withUser("admin").password("admin").roles("ROLE");
        }
        
        @Override
        public void configure(HttpSecurity http) throws Exception {
            http.authorizeRequests()
                    .antMatchers("/categoria/**").permitAll()
                    .antMatchers("/h2/**").permitAll()
                    .antMatchers("/h2-console/**").permitAll()
                    .anyRequest().authenticated().and()
                    .headers().frameOptions().sameOrigin().and()
                    .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS).and()
                    .csrf().ignoringAntMatchers("/h2-console/**").and()
                    .csrf().disable();
        }
        
        @Override
        public void configure(ResourceServerSecurityConfigurer resources) throws Exception {
            resources.stateless(true);
        }
        
    }

    . Para permitir a utilização do localhost:8080/h2 é necessário utilizar os métodos abaixo no método "configure"

        http.authorizeRequests()
            .antMatchers("/h2/**").permitAll()
            .antMatchers("/h2-console/**").permitAll()
            .and().csrf().ignoringAntMatchers("/h2-console/**")
            .and().headers().frameOptions().sameOrigin();

. Inclua a classe abaixo no projeto:

    package com.example.algamoneyapi.config;

    import org.springframework.beans.factory.annotation.Autowired;
    import org.springframework.context.annotation.Bean;
    import org.springframework.context.annotation.Configuration;
    import org.springframework.security.authentication.AuthenticationManager;
    import org.springframework.security.oauth2.config.annotation.configurers.ClientDetailsServiceConfigurer;
    import org.springframework.security.oauth2.config.annotation.web.configuration.AuthorizationServerConfigurerAdapter;
    import org.springframework.security.oauth2.config.annotation.web.configuration.EnableAuthorizationServer;
    import org.springframework.security.oauth2.config.annotation.web.configurers.AuthorizationServerEndpointsConfigurer;
    import org.springframework.security.oauth2.provider.token.TokenStore;
    import org.springframework.security.oauth2.provider.token.store.InMemoryTokenStore;

    @Configuration
    @EnableAuthorizationServer
    public class AuthorizationServerConfig extends AuthorizationServerConfigurerAdapter {

        @Autowired
        private AuthenticationManager authenticationManager;
        
        @Override
        public void configure(ClientDetailsServiceConfigurer clients) throws Exception {
            clients.inMemory()
                .withClient("angular")
                .secret("@ngul@r0")
                .scopes("read", "write")
                .authorizedGrantTypes("password")
                .accessTokenValiditySeconds(1800);
        }
        
        @Override
        public void configure(AuthorizationServerEndpointsConfigurer endpoints) throws Exception {
            endpoints
                .tokenStore(tokenStore())
                .authenticationManager(authenticationManager);
        }
        
        @Bean
        public TokenStore tokenStore() {
            return new InMemoryTokenStore();
        }
        
    }


. Inclua a classe abaixo no projeto, ela ajudará na Injeção de Dependência da classe AuthenticationManager

    package com.example.algamoneyapi.config;

    import org.springframework.context.annotation.Bean;
    import org.springframework.context.annotation.Configuration;
    import org.springframework.security.authentication.AuthenticationManager;
    import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
    import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;
    import org.springframework.security.crypto.password.NoOpPasswordEncoder;
    import org.springframework.security.crypto.password.PasswordEncoder;

    @Configuration
    @EnableWebSecurity
    public class OAuthSecurityConfig extends WebSecurityConfigurerAdapter {

        @Bean
        @Override
        public AuthenticationManager authenticationManager() throws Exception {
            return super.authenticationManager();
        }

        @Bean
        public PasswordEncoder passwordEncoder() {
            return NoOpPasswordEncoder.getInstance();
        }
    }


. Crie uma chamada no Postman como abaixo:

    Method : POST
    url : localhost:8080/oauth/token

    . Em Authoritation coloque os parâmetros abaixo:

        Type : Basic Auth
        User : angular
        Password : @ngul@r0

        // De Update Request

    . em Body  coloque os parâmetros abaixo:

        x-www-form-urlencoded : true

        key                             value
        ----                            -----
        client                          angular
        username                        admin
        Password                        admin
        grant_type                      password

    . Acione o send e pegue o valor do "access_token"


. Acesse no Postman a URL abaixo:


    Method : GET
    URL : http://localhost:8080/categoria/api/

    Method : GET
    URL : http://localhost:8080/categoria/api/1

    . Deixe em Authoritation no Type como "No Auth". Isso permitirá colocar o parâmetro Authentication
        no Headers como abaixo.

    . Acesse a aba Headers e coloque os parâmetros abaixo:

        key                             value
        ----                            -----
        Authorization                   Bearer + [Access Token]


        . Acione o Send


https://www.devglan.com/spring-security/spring-boot-security-oauth2-example




Aula 6.4. JSON Web Tokens - JWT
-------------------------------

. Consultar o site https://jwt.io



Aula 6.5. Configurando JWT no projeto
-------------------------------------

. Adione a dependência abaixo no pom.xml do projeto:

    <dependency>
        <groupId>org.springframework.security</groupId>
        <artifactId>spring-security-jwt</artifactId>
    </dependency>

. Altere a classe AuthorizationServerConfig como abaixo:

    package com.example.algamoneyapi.config;

    import org.springframework.beans.factory.annotation.Autowired;
    import org.springframework.context.annotation.Bean;
    import org.springframework.context.annotation.Configuration;
    import org.springframework.security.authentication.AuthenticationManager;
    import org.springframework.security.oauth2.config.annotation.configurers.ClientDetailsServiceConfigurer;
    import org.springframework.security.oauth2.config.annotation.web.configuration.AuthorizationServerConfigurerAdapter;
    import org.springframework.security.oauth2.config.annotation.web.configuration.EnableAuthorizationServer;
    import org.springframework.security.oauth2.config.annotation.web.configurers.AuthorizationServerEndpointsConfigurer;
    import org.springframework.security.oauth2.provider.token.TokenStore;
    import org.springframework.security.oauth2.provider.token.store.JwtAccessTokenConverter;
    import org.springframework.security.oauth2.provider.token.store.JwtTokenStore;

    @Configuration
    @EnableAuthorizationServer
    public class AuthorizationServerConfig extends AuthorizationServerConfigurerAdapter {

        @Autowired
        private AuthenticationManager authenticationManager;
        
        @Override
        public void configure(ClientDetailsServiceConfigurer clients) throws Exception {
            clients.inMemory()
                .withClient("angular")
                .secret("@ngul@r0")
                .scopes("read", "write")
                .authorizedGrantTypes("password")
                .accessTokenValiditySeconds(1800);
        }
        
        @Override
        public void configure(AuthorizationServerEndpointsConfigurer endpoints) throws Exception {
            endpoints
                .tokenStore(tokenStore())
                .accessTokenConverter(accessTokenConverter())       // Linha alterada para adequar JWT
                .authenticationManager(authenticationManager);
        }   
        
        // Método criado para JWT
        @Bean
        public JwtAccessTokenConverter accessTokenConverter() {
            JwtAccessTokenConverter accessTokenConverter = new JwtAccessTokenConverter();
            accessTokenConverter.setSigningKey("algaworks");
            return accessTokenConverter;
        }

        @Bean
        public TokenStore tokenStore() {
            return new JwtTokenStore(accessTokenConverter());   // Linha alterada para adequar ao JWT
        }
        
    }

. Crie uma chamada no Postman como abaixo:

    Method : POST
    url : localhost:8080/oauth/token


    . Em Authoritation coloque os parâmetros abaixo:

        Type : Basic Auth
        User : angular
        Password : @ngul@r0

        // De Update Request

    . em Body  coloque os parâmetros abaixo:

        x-www-form-urlencoded : true

        key                             value
        ----                            -----
        client                          angular
        username                        admin
        Password                        admin
        grant_type                      password

    . Acione o send e pegue o valor do "access_token"

    . Selecione o access_token gerado é submeta ele no site https://jwt.io e valide ele.

    . No Verify Signature altere o valor da chave de "secret" para "algaworks" conforme colocado no método
        accessTokenConverter.

. Acesse no Postman a URL abaixo:


    Method : GET
    URL : http://localhost:8080/categoria/api/

    Method : GET
    URL : http://localhost:8080/categoria/api/1

    . Deixe em Authoritation no Type como "No Auth". Isso permitirá colocar o parâmetro Authentication
        no Headers como abaixo.

    . Acesse a aba Headers e coloque os parâmetros abaixo:

        key                             value
        ----                            -----
        Authoritation                   Bearer + [Access Token]


        . Acione o Send


Aula 6.6. Renovando o access token com o refresh token
------------------------------------------------------

. Altere o parâmetro .accessTokenValiditySeconds para 20 segundos:

    ...
    @Configuration
    @EnableAuthorizationServer
    public class AuthorizationServerConfig extends AuthorizationServerConfigurerAdapter {

        @Autowired
        private AuthenticationManager authenticationManager;
        
        @Override
        public void configure(ClientDetailsServiceConfigurer clients) throws Exception {
            clients.inMemory()
                .withClient("angular")
                .secret("@ngul@r0")
                .scopes("read", "write")
                .authorizedGrantTypes("password")
                .accessTokenValiditySeconds(20);    // Altere para 20 seg
        }
        
        ...
    }

. Com essa alteração o token terá um tempo curto de existência. Acesse o Postman, faça a criação de um
    token como nos exemplos anteriores e execute uma url com ele durante 20 seg, ou mais para verificar
    a expiração do token.
    
    # Para obter o token
    Method : POST
    url : localhost:8080/oauth/token

    # Utilize o token no Authorization da url abaixo
    Method : GET
    URL : http://localhost:8080/categoria/api/

. Faça as alterações abaixo nos parâmetros do token:

        ...
        @Override
        public void configure(ClientDetailsServiceConfigurer clients) throws Exception {
            clients.inMemory()
                .withClient("angular")
                .secret("@ngul@r0")
                .scopes("read", "write")
                .authorizedGrantTypes("password", "refresh_token")          // Inclua o param "refresh_token"
                .accessTokenValiditySeconds(20)                            // Altere para 20 seg
                .refreshTokenValiditySeconds( 3600 * 24 );                   // Tempo para expirar o refreshToken de 1 dia
        }
        
        @Override
        public void configure(AuthorizationServerEndpointsConfigurer endpoints) throws Exception {
            endpoints
                .tokenStore(tokenStore())
                .accessTokenConverter(accessTokenConverter()) 
                .reuseRefreshTokens(false)                                  // Um novo refreshToken será criado a cada solicitação
                .authenticationManager(authenticationManager);
                
        }   
        ...

. Faça a solicitação novamente do token e observe que veio o refresh_token:

    # Para obter o token
    Method : POST
    url : localhost:8080/oauth/token

. Espere a expiração do token e solicite um novo token com o refresh_token. Para isso será necessário 
    chamar a url acima. Porém sem o usuário e senha, somente com o grant_type igual a refresh_token. Crie uma nova requisição de token
    como abaixo:

    # Para obter o token
    Method : POST
    url : localhost:8080/oauth/token

    . Em Authoritation coloque os parâmetros abaixo:

        Type : Basic Auth
        User : angular
        Password : @ngul@r0

    . No "body" em x-wwww-form-urlencoded = true

        key                             value
        ----                            -----
        grant_type                      refresh_token
        refresh_token                   [ access_token adquirido no passo anterior de obtenção do refresh_token que veio no cookie]

    . Dê um send, copie o novo access_token obtido com a requisição acima e utilize para executar a requisição abaixo:

        # Utilize o token no Authorization da url abaixo
        Method : GET
        URL : http://localhost:8080/categoria/api/



https://dassum.medium.com/securing-spring-boot-rest-api-with-json-web-token-and-jdbc-token-store-67558a7d6c29




Aula 6.7. Movendo o refresh token para o cookie
-----------------------------------------------

. Para deixar mais seguro nossos tokens iremos retirar o refresh_token do corpo da resposta da nossa requisição e colocá-lo
    num cookie http e assim deixar mais segura a nossa aplicação.

. Crie a classe abaixo no projeto:

    package com.example.algamoneyapi.token;

    import javax.servlet.http.Cookie;
    import javax.servlet.http.HttpServletRequest;
    import javax.servlet.http.HttpServletResponse;

    import org.springframework.core.MethodParameter;
    import org.springframework.http.MediaType;
    import org.springframework.http.converter.HttpMessageConverter;
    import org.springframework.http.server.ServerHttpRequest;
    import org.springframework.http.server.ServerHttpResponse;
    import org.springframework.http.server.ServletServerHttpRequest;
    import org.springframework.http.server.ServletServerHttpResponse;
    import org.springframework.security.oauth2.common.DefaultOAuth2AccessToken;
    import org.springframework.security.oauth2.common.OAuth2AccessToken;
    import org.springframework.web.bind.annotation.ControllerAdvice;
    import org.springframework.web.servlet.mvc.method.annotation.ResponseBodyAdvice;

    @ControllerAdvice
    public class RefreshTokenPostProcessor implements ResponseBodyAdvice<OAuth2AccessToken> {

        @Override
        public boolean supports(MethodParameter returnType, Class<? extends HttpMessageConverter<?>> converterType) {
            return returnType.getMethod().getName().equals("postAccessToken");
        }

        @Override
        public OAuth2AccessToken beforeBodyWrite(OAuth2AccessToken body, MethodParameter returnType,
                MediaType selectedContentType, Class<? extends HttpMessageConverter<?>> selectedConverterType,
                ServerHttpRequest request, ServerHttpResponse response) {
            
            HttpServletRequest req = ((ServletServerHttpRequest) request).getServletRequest();
            HttpServletResponse resp = ((ServletServerHttpResponse) response).getServletResponse();
            
            DefaultOAuth2AccessToken token = (DefaultOAuth2AccessToken) body;
            
            String refreshToken = body.getRefreshToken().getValue();
            adicionarRefreshTokenNoCookie(refreshToken, req, resp);
            removerRefreshTokenDoBody(token);
            
            return body;
        }

        private void removerRefreshTokenDoBody(DefaultOAuth2AccessToken token) {
            token.setRefreshToken(null);
        }

        private void adicionarRefreshTokenNoCookie(String refreshToken, HttpServletRequest req, HttpServletResponse resp) {
            Cookie refreshTokenCookie = new Cookie("refreshToken", refreshToken);
            refreshTokenCookie.setHttpOnly(true);
            refreshTokenCookie.setSecure(false); // TODO: Mudar para true em producao
            refreshTokenCookie.setPath(req.getContextPath() + "/oauth/token");
            refreshTokenCookie.setMaxAge(2592000);
            resp.addCookie(refreshTokenCookie);
        }

    }


    . No parâmetro abaixo estamos informando que o refresh_token poderá ser colocado num cookie http. Se fosse true, ele só
        viria num cookie https:

        refreshTokenCookie.setHttpOnly(true);

. Execute o projeto, acesse o postman e solicite o token como abaixo. 

    # Para obter o token
    Method : POST
    url : localhost:8080/oauth/token

    . Verifique que agora o refres_token não veio, ele está 
        disponivel no cookie.

    . Em Authoritation coloque os parâmetros abaixo:

        Type : Basic Auth
        User : angular
        Password : @ngul@r0

    . No "body" em x-wwww-form-urlencoded = true

        key                             value
        ----                            -----
        grant_type                      refresh_token
        refresh_token                   [ access_token adquirido no passo anterior que está no cookie de obtenção do refresh_token ]

    . Dê um send, copie o access_token obtido e utilize  no lugar do token para executar a requisição abaixo:

        # Utilize o token no Authorization da url abaixo
        Method : GET
        URL : http://localhost:8080/categoria/api/




Aula 6.8. Movendo o refresh token do cookie para a requisição
-------------------------------------------------------------

. Inclua a classe abaixo no projeto:

    package com.example.algamoneyapi.token;

    import java.io.IOException;
    import java.util.Map;

    import javax.servlet.Filter;
    import javax.servlet.FilterChain;
    import javax.servlet.FilterConfig;
    import javax.servlet.ServletException;
    import javax.servlet.ServletRequest;
    import javax.servlet.ServletResponse;
    import javax.servlet.http.Cookie;
    import javax.servlet.http.HttpServletRequest;
    import javax.servlet.http.HttpServletRequestWrapper;

    import org.apache.catalina.util.ParameterMap;
    import org.springframework.core.Ordered;
    import org.springframework.core.annotation.Order;
    import org.springframework.stereotype.Component;

    @Component
    @Order(Ordered.HIGHEST_PRECEDENCE)
    public class RefreshTokenCookiePreProcessorFilter implements Filter {

        @Override
        public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain)
                throws IOException, ServletException {
            
            HttpServletRequest req = (HttpServletRequest) request;
            
            if ("/oauth/token".equalsIgnoreCase(req.getRequestURI()) 
                    && "refresh_token".equals(req.getParameter("grant_type"))
                    && req.getCookies() != null) {
                for (Cookie cookie : req.getCookies()) {
                    if (cookie.getName().equals("refreshToken")) {
                        String refreshToken = cookie.getValue();
                        req = new MyServletRequestWrapper(req, refreshToken);
                    }
                }
            }
            
            chain.doFilter(req, response);
        }
        
        @Override
        public void destroy() {
            
        }

        @Override
        public void init(FilterConfig arg0) throws ServletException {
            
        }
        
        static class MyServletRequestWrapper extends HttpServletRequestWrapper {

            private String refreshToken;
            
            public MyServletRequestWrapper(HttpServletRequest request, String refreshToken) {
                super(request);
                this.refreshToken = refreshToken;
            }
            
            @Override
            public Map<String, String[]> getParameterMap() {
                ParameterMap<String, String[]> map = new ParameterMap<>(getRequest().getParameterMap());
                map.put("refresh_token", new String[] { refreshToken });
                map.setLocked(true);
                return map;
            }
            
        }

    }

. Execute o projeto, acesse o postman e solicite o token como abaixo. 

    # Para obter o token
    Method : POST
    url : localhost:8080/oauth/token

    . Em Authoritation coloque os parâmetros abaixo:

        Type : Basic Auth
        User : angular
        Password : @ngul@r0

    . No "body" em x-wwww-form-urlencoded = true

        key                             value
        ----                            -----
        grant_type                      refresh_token
        refresh_token                   [ access_token adquirido no passo anterior que está no cookie de obtenção do refresh_token ]

    . Desmarque o parâmetro refresh_token, submeta novamente a requisição e verifique se o access_token veio.


        . O objetivo é passar nos parâmetros do Body somente o grant_type, sem ter que passar o refresh_token e expo-lo na requisição. 
        . Como o cookie fica armazenado no client, o server através da classe Filter acima recupera o conteúdo do Cookie e adiciona aos
            parâmetros automaticamente, sem a necessidade de enviá-lo nos parâmetros do Body

    . Dê um send, acesse a aba Cookie, copie o access_token obtido no Cookie e utilize  no lugar do token para executar a requisição abaixo:

        # Utilize o token no Authorization da url abaixo
        Method : GET
        URL : http://localhost:8080/categoria/api/



Aula 06.09. O que é CORS
-----------------------

    CORS (Cross-Origin Resource Sharing) é uma especificação do W3C que, quando implementado pelo navegador, permite que um site acesse 
    recursos de outro site mesmo estando em domínios diferentes.

    Explicando um pouco melhor: os navegadores fazem uso de uma funcionalidade de segurança chamada Same-Origin Policy: um recurso 
    de um site só pode ser chamado por outro site se os 2 sites estiverem sob o mesmo domínio (mesmo endereço, 
    por ex.: meudominio.com.br). Isso limita a chamada de APIs REST por aplicações JS, por exemplo, hospedadas em 
    servidores diferentes (front-end e back-end em camadas distintas). Isso porque o navegador considera recursos do mesmo 
    domínio somente aqueles que usam o mesmo protocolo (http ou https), a mesma porta e o mesmo endereço (mesmo subdomínios, 
    subdominio.meudominio.com.br, por exemplo, não são considerados seguros e não funcionam).

    Antes do CORS, era possível contornar essa restrição criando algum tipo de componente que servisse de proxy para as chamadas externas. 
    O uso do JSONP (JSON with padding) para APIs que dão suporte (pouco comum) também era uma saída. Contudo o JSONP é limitado 
    somente a chamadas do tipo GET o que causa bastante transtorno para APIs baseadas em REST (que faz uso dos outros 
    verbos POST, PUT e DELETE).

    Com a implementação do CORS um domínio permite comunicação com outro de forma livre, independente do método da chamada 
    (GET, POST, PUT ou DELETE) contanto que o domínio de destino tenha especificado esse tipo de comunicação.

    Geralmente essa configuração é feita no lado da API e cada framework tem sua forma de configuração. A parte importante 
    é a inclusão do Access-Control-Allow-Origin no header da reposta da API.

    Então, em um cenário bem simples, sua aplicação JS cliente em dev.meudominio.com.br faz um request para a 
    API (normalmente numa chamada AJAX) para o servidor api.meudominio.com.br. A resposta da API deve incluir no 
    header da resposta o Access-Control-Allow-Origin: http://dev.meudominio.com.br deixando claro para o navegador 
    que ele aceita requests originados somente desse domínio.

    Então em um exemplo de chamada de dev.meudominio.com.br para api.meudominio.com.br/recurso.php, gera esse request header:


        GET /recurso.php HTTP/1.1
        User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_8_5) AppleWebKit/536.30.1 (KHTML, like Gecko) Version/6.0.5 Safari/536.30.1
        Accept: application/json, text/plain, */*
        Referer: http://dev.meudominio.com.br/
        Origin: http://dev.meudominio.com.br/


    E a API deve gerar a resposta com o response header abaixo:

        HTTP/1.1 200 OK
        Content-Type: application/json;charset=UTF-8
        Date: Wed, 20 Nov 2013 19:36:00 GMT
        Server: Apache-Coyote/1.1
        Content-Length: 35
        Connection: keep-alive
        Access-Control-Allow-Origin: http://dev.meudominio.com.br

    Se o conteúdo de Origin for idêntico ao de Access-Control-Allow-Origin a comunicação é permitida pelo navegador.

    Em um cenário mais complexo, existem outros headers que precisam ser configurados na resposta. De novo, isso varia com os 
    frameworks que estão sendo utilizados (cliente e servidor).


https://www.youtube.com/watch?v=GZV-FUdeVwE
https://howtodoinjava.com/spring5/webmvc/spring-mvc-cors-configuration/
https://www.baeldung.com/spring-cors
https://helpdev.com.br/2019/01/03/java-configurando-cors-no-spring-boot-e-security/


Aula 06.10. Criando filtro para CORS
------------------------------------

    . Implemente a classe abaixo no projeto:

        package com.example.algamoneyapi.cors;

        import java.io.IOException;

        import javax.servlet.Filter;
        import javax.servlet.FilterChain;
        import javax.servlet.FilterConfig;
        import javax.servlet.ServletException;
        import javax.servlet.ServletRequest;
        import javax.servlet.ServletResponse;
        import javax.servlet.http.HttpServletRequest;
        import javax.servlet.http.HttpServletResponse;

        import org.springframework.core.Ordered;
        import org.springframework.core.annotation.Order;
        import org.springframework.stereotype.Component;

        @Component
        @Order(Ordered.HIGHEST_PRECEDENCE)
        public class CorsFilter implements Filter {

            private String originPermitida = "http://localhost:8000"; // TODO: Configurar para diferentes ambientes
            
            @Override
            public void doFilter(ServletRequest req, ServletResponse resp, FilterChain chain)
                    throws IOException, ServletException {
                
                HttpServletRequest request = (HttpServletRequest) req;
                HttpServletResponse response = (HttpServletResponse) resp;
                
                response.setHeader("Access-Control-Allow-Origin", originPermitida);
                response.setHeader("Access-Control-Allow-Credentials", "true"); // Para permitir trabalhar com os cookies
                
                if ("OPTIONS".equals(request.getMethod()) && originPermitida.equals(request.getHeader("Origin"))) {
                    response.setHeader("Access-Control-Allow-Methods", "POST, GET, DELETE, PUT, OPTIONS");
                    response.setHeader("Access-Control-Allow-Headers", "Authorization, Content-Type, Accept");
                    response.setHeader("Access-Control-Max-Age", "3600");
                    
                    response.setStatus(HttpServletResponse.SC_OK);  // Serve para parar a chamada do prox filter
                } else {
                    chain.doFilter(req, resp);
                }
                
            }
            
            @Override
            public void destroy() {
            }

            @Override
            public void init(FilterConfig arg0) throws ServletException {
            }

        }


Aula 06.11. Movendo o usuário para o banco de dados
---------------------------------------------------

    . Implemente no arquivo schema.sql as DDLs abaixo:

        CREATE TABLE usuario (
            codigo BIGINT(20) PRIMARY KEY,
            nome VARCHAR(50) NOT NULL,
            email VARCHAR(50) NOT NULL,
            senha VARCHAR(150) NOT NULL
        );

        CREATE TABLE permissao (
            codigo BIGINT(20) PRIMARY KEY,
            descricao VARCHAR(50) NOT NULL
        );

        CREATE TABLE usuario_permissao (
            codigo_usuario BIGINT(20) NOT NULL,
            codigo_permissao BIGINT(20) NOT NULL,
            PRIMARY KEY (codigo_usuario, codigo_permissao),
            FOREIGN KEY (codigo_usuario) REFERENCES usuario(codigo),
            FOREIGN KEY (codigo_permissao) REFERENCES permissao(codigo)
        );

    . Implemente no arquivo data.sql as DMLs abaixo:

        INSERT INTO usuario (codigo, nome, email, senha) values (1, 'Administrador', 'admin@algamoney.com', '$2a$10$X607ZPhQ4EgGNaYKt3n4SONjIv9zc.VMWdEuhCuba7oLAL5IvcL5.');
        INSERT INTO usuario (codigo, nome, email, senha) values (2, 'Maria Silva', 'maria@algamoney.com', '$2a$10$Zc3w6HyuPOPXamaMhh.PQOXvDnEsadztbfi6/RyZWJDzimE8WQjaq');

        INSERT INTO permissao (codigo, descricao) values (1, 'ROLE_CADASTRAR_CATEGORIA');
        INSERT INTO permissao (codigo, descricao) values (2, 'ROLE_PESQUISAR_CATEGORIA');

        INSERT INTO permissao (codigo, descricao) values (3, 'ROLE_CADASTRAR_PESSOA');
        INSERT INTO permissao (codigo, descricao) values (4, 'ROLE_REMOVER_PESSOA');
        INSERT INTO permissao (codigo, descricao) values (5, 'ROLE_PESQUISAR_PESSOA');

        INSERT INTO permissao (codigo, descricao) values (6, 'ROLE_CADASTRAR_LANCAMENTO');
        INSERT INTO permissao (codigo, descricao) values (7, 'ROLE_REMOVER_LANCAMENTO');
        INSERT INTO permissao (codigo, descricao) values (8, 'ROLE_PESQUISAR_LANCAMENTO');

        -- admin
        INSERT INTO usuario_permissao (codigo_usuario, codigo_permissao) values (1, 1);
        INSERT INTO usuario_permissao (codigo_usuario, codigo_permissao) values (1, 2);
        INSERT INTO usuario_permissao (codigo_usuario, codigo_permissao) values (1, 3);
        INSERT INTO usuario_permissao (codigo_usuario, codigo_permissao) values (1, 4);
        INSERT INTO usuario_permissao (codigo_usuario, codigo_permissao) values (1, 5);
        INSERT INTO usuario_permissao (codigo_usuario, codigo_permissao) values (1, 6);
        INSERT INTO usuario_permissao (codigo_usuario, codigo_permissao) values (1, 7);
        INSERT INTO usuario_permissao (codigo_usuario, codigo_permissao) values (1, 8);

        -- maria
        INSERT INTO usuario_permissao (codigo_usuario, codigo_permissao) values (2, 2);
        INSERT INTO usuario_permissao (codigo_usuario, codigo_permissao) values (2, 5);
        INSERT INTO usuario_permissao (codigo_usuario, codigo_permissao) values (2, 8);


    . Crie as classes model abaixo:

        /*
         *  Usuario
         */

        package com.example.algamoneyapi.model;

        import java.util.List;

        import javax.persistence.Entity;
        import javax.persistence.FetchType;
        import javax.persistence.Id;
        import javax.persistence.JoinColumn;
        import javax.persistence.JoinTable;
        import javax.persistence.ManyToMany;
        import javax.persistence.Table;

        @Entity
        @Table(name = "usuario")
        public class Usuario {

            @Id
            private Long codigo;

            private String nome;
            private String email;
            private String senha;

            @ManyToMany(fetch = FetchType.EAGER)
            @JoinTable(name = "usuario_permissao", joinColumns = @JoinColumn(name = "codigo_usuario")
                , inverseJoinColumns = @JoinColumn(name = "codigo_permissao"))
            private List<Permissao> permissoes;

            public Long getCodigo() {
                return codigo;
            }

            public void setCodigo(Long codigo) {
                this.codigo = codigo;
            }

            public String getNome() {
                return nome;
            }

            public void setNome(String nome) {
                this.nome = nome;
            }

            public String getEmail() {
                return email;
            }

            public void setEmail(String email) {
                this.email = email;
            }

            public String getSenha() {
                return senha;
            }

            public void setSenha(String senha) {
                this.senha = senha;
            }

            public List<Permissao> getPermissoes() {
                return permissoes;
            }

            public void setPermissoes(List<Permissao> permissoes) {
                this.permissoes = permissoes;
            }

            @Override
            public int hashCode() {
                final int prime = 31;
                int result = 1;
                result = prime * result + ((codigo == null) ? 0 : codigo.hashCode());
                return result;
            }

            @Override
            public boolean equals(Object obj) {
                if (this == obj)
                    return true;
                if (obj == null)
                    return false;
                if (getClass() != obj.getClass())
                    return false;
                Usuario other = (Usuario) obj;
                if (codigo == null) {
                    if (other.codigo != null)
                        return false;
                } else if (!codigo.equals(other.codigo))
                    return false;
                return true;
            }

        }





        /*
         *  Permissao
         */


        package com.example.algamoney.api.model;

        import javax.persistence.Entity;
        import javax.persistence.Id;
        import javax.persistence.Table;

        @Entity
        @Table(name = "permissao")
        public class Permissao {

            @Id
            private Long codigo;
            private String descricao;

            public Long getCodigo() {
                return codigo;
            }

            public void setCodigo(Long codigo) {
                this.codigo = codigo;
            }

            public String getDescricao() {
                return descricao;
            }

            public void setDescricao(String descricao) {
                this.descricao = descricao;
            }

            @Override
            public int hashCode() {
                final int prime = 31;
                int result = 1;
                result = prime * result + ((codigo == null) ? 0 : codigo.hashCode());
                return result;
            }

            @Override
            public boolean equals(Object obj) {
                if (this == obj)
                    return true;
                if (obj == null)
                    return false;
                if (getClass() != obj.getClass())
                    return false;
                Permissao other = (Permissao) obj;
                if (codigo == null) {
                    if (other.codigo != null)
                        return false;
                } else if (!codigo.equals(other.codigo))
                    return false;
                return true;
            }

        }


    . Crie a classe repository abaixo no projeto:

        package com.example.algamoneyapi.repository;

        import java.util.Optional;

        import org.springframework.data.jpa.repository.JpaRepository;

        import com.example.algamoney.api.model.Usuario;

        public interface UsuarioRepository extends JpaRepository<Usuario, Long> {

            public Optional<Usuario> findByEmail(String email);
            
        }


    . Altere na classe ResourceServerConfig o método configure como abaixo :

        // De

        @Autowired
        public void configure(AuthenticationManagerBuilder auth) throws Exception {
            auth.inMemoryAuthentication()
                    .withUser("admin").password("admin").roles("ROLE");
        }


        // Para

        @Autowired
        private UserDetailsService userDetailsService

        @Autowired
        public void configure(AuthenticationManagerBuilder auth) throws Exception {
            auth.userDetailsService(userDetailsService).passwordEncoder(passwordEncoder());
        }    


    . Ainda no arquivo ResourceServerConfig implemente o método abaixo:

        // @Bean            // O @Bean foi comentado devido a problemas mais a frente com as aulas o @Profile. Devido ao metodo ser declarado em mais de um
        //                      lugar, o projeto não levanta. Até este ponto pode ser usado, mas qdo for criado a classe BasicSecurityConfig vai parar
        public PasswordEncoder passwordEncoder() {
            return new BCryptPasswordEncoder();
        }


    . Crie a classe abaixo no projeto:

        package com.example.algamoneyapi.security;

        import java.util.Collection;
        import java.util.HashSet;
        import java.util.Optional;
        import java.util.Set;

        import org.springframework.beans.factory.annotation.Autowired;
        import org.springframework.security.core.GrantedAuthority;
        import org.springframework.security.core.authority.SimpleGrantedAuthority;
        import org.springframework.security.core.userdetails.User;
        import org.springframework.security.core.userdetails.UserDetails;
        import org.springframework.security.core.userdetails.UserDetailsService;
        import org.springframework.security.core.userdetails.UsernameNotFoundException;
        import org.springframework.stereotype.Service;

        import com.example.algamoney.api.model.Usuario;
        import com.example.algamoney.api.repository.UsuarioRepository;

        @Service
        public class AppUserDetailsService implements UserDetailsService {

            @Autowired
            private UsuarioRepository usuarioRepository;
            
            @Override
            public UserDetails loadUserByUsername(String email) throws UsernameNotFoundException {
                Optional<Usuario> usuarioOptional = usuarioRepository.findByEmail(email);
                Usuario usuario = usuarioOptional.orElseThrow(() -> new UsernameNotFoundException("Usuário e/ou senha incorretos"));
                return new User(email, usuario.getSenha(), getPermissoes(usuario));
            }

            private Collection<? extends GrantedAuthority> getPermissoes(Usuario usuario) {
                Set<SimpleGrantedAuthority> authorities = new HashSet<>();
                usuario.getPermissoes().forEach(p -> authorities.add(new SimpleGrantedAuthority(p.getDescricao().toUpperCase())));
                return authorities;
            }

        }

    . As configurações abaixo estão no Postman -> Body -> x-www-form-urlencoded

    . Subir a aplicação testando, executar localhost:8080/oauth/token com o usuário admin@algamoney.com e password admin para 
        recuperar o access_token

    . execute novamente localhost:808/oauth/token com usuário e senha maria@algamoney.com maria respectivamente para recuperar
        o access_token.


https://www.javadevjournal.com/spring/spring-security-userdetailsservice/
        



Aula 06.12. Adicionando permissões de acesso
--------------------------------------------

    . Incluir a anotação  @EnableGlobalMethodSecurity(prePostEnabled=true) na classe ResourceServerConfig. Isto habilita o controle
        de segurança nos métodos das API (classes resource):

        @Configuration
        @EnableWebSecurity
        @EnableResourceServer
        @EnableGlobalMethodSecurity(prePostEnabled=true)
        public class ResourceServerConfig extends ResourceServerConfigurerAdapter {

            ...

        }

    . Inclua o método abaixo na classe ResourceServerConfig:

        ...
        @Bean
        public MethodSecurityExpressionHandler createExpressionHandler(){
            return new OAuth2MethodSecurityExpressionHandler();
        }
        ...

    . Acessar os métodos das classes resources e incluir a anotação @PreAuthorize:

        @GetMapping
        @PreAuthorize("hasAuthority('ROLE_PESQUISAR_CATEGORIA') and #oauth2.hasScope('read')")
        public  ResponseEntity<?> findAll() {

            List<Categoria> categorias = null;

            try {
                categorias = categoriaRepository.findAll();

                return ResponseEntity.ok(categorias);
            } catch (Exception e) {
                return ResponseEntity.badRequest().body(e.getMessage());
            }

        }

        @GetMapping(path = "{codigo}")
        @PreAuthorize("hasAuthority('ROLE_PESQUISAR_CATEGORIA') and #oauth2.hasScope('read')")
        public ResponseEntity<?> findById(@PathVariable Long codigo, HttpServletResponse response) {

            try {
                Categoria categoria = categoriaRepository.findById(codigo).get();
        
                URI uri = ServletUriComponentsBuilder.fromCurrentRequestUri().path("")
                        .buildAndExpand(categoria.getCodigo()).toUri();

                response.setHeader("Location", uri.toASCIIString());

                return ResponseEntity.ok( categoria );
            }catch( Exception e) {
                return ResponseEntity.notFound().build();
            }
            
            
        }

        @PostMapping
        @PreAuthorize("hasAuthority('ROLE_CADASTRAR_CATEGORIA') and #oauth2.hasScope('write')")
        // @ResponseStatus( HttpStatus.CREATED)
        public ResponseEntity<?> insert( @Valid @RequestBody Categoria categoria, HttpServletResponse response ) {
            /*
            * if ( result.hasErrors() ) { Map<String, String> errors = new HashMap<>();
            * 
            * for ( FieldError error : result.getFieldErrors()) { errors.put(
            * error.getField(), error.getDefaultMessage()); }
            * 
            * return ResponseEntity.unprocessableEntity().body(errors); }
            */		
            try {
                Categoria categoriaSalva = categoriaRepository.save(categoria);

                URI uri = ServletUriComponentsBuilder.fromCurrentRequestUri().path("/{codigo}")
                        .buildAndExpand(categoriaSalva.getCodigo()).toUri();

                response.setHeader("Location", uri.toASCIIString());

                return ResponseEntity.created(uri).body(categoriaSalva);
            } catch (Exception e) {
                // TODO Auto-generated catch block
                return ResponseEntity.badRequest().body(e.getMessage());
            }

        }

        . Com a inclusão das permissões através das roles cadastrada nas permissões de cada cliente, não será mais 
            necessário a configuração feita no método ResourceServerConfig.configure( HttpSecurity http ) que realiza
            a autorização de acesso para todos ao contexto ("/categoria/**) neste caso podemos eliminar essa linha.

            http.authorizeRequests()
                    .antMatchers("/categoria/**").permitAll()

        . Deixe esse método como abaixo:

            http.authorizeRequests()
                    .antMatchers("/h2/**").permitAll()
                    .antMatchers("/h2-console/**").permitAll()
                    .anyRequest().authenticated().and()
                    .headers().frameOptions().sameOrigin().and()
                    .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS).and()
                    .csrf().ignoringAntMatchers("/h2-console/**").and()
                    .csrf().disable();

        . Levante a aplicação; acesso o Postman; altere as configurações do  localhost:8080/oauth/token no body deixando como abaixo:

            username : maria@algamoney.com
            password : maria

        . Transporte o token obtido para a consulta de categoria e execute a query.

        . Para trabalhar com os escopos "read" e "write" temos que alterar na classe AuthorizationServerConfig no metodo
            configure( ClienteDetailsServiceConfigurer clients) o objeto clients.


            ...

            @Override
            public void configure(ClientDetailsServiceConfigurer clients) throws Exception {
                clients.inMemory()
                        .withClient("angular")
                        .secret("@ngul@r0")
                        .scopes("read", "write")
                        .authorizedGrantTypes("password", "refresh_token")
                        .accessTokenValiditySeconds(1800)
                        .refreshTokenValiditySeconds(3600 * 24)
                    .and()
                        .withClient("mobile")
                        .secret("m0b1l30")
                        .scopes("read")
                        .authorizedGrantTypes("password", "refresh_token")
                        .accessTokenValiditySeconds(1800)
                        .refreshTokenValiditySeconds(3600 * 24);
            }

            ...


            . Observe que foi incluído mais um and() para o cliente mobile e ele só tem o escopo "read" que serão utilizados
                nos métodos das classes resources na anotação @PreAuthorize:

                ...

                @GetMapping
                @PreAuthorize("hasAuthority('ROLE_PESQUISAR_CATEGORIA') and #oauth2.hasScope('read')")
                public  ResponseEntity<?> findAll() {

                    List<Categoria> categorias = null;

                    try {
                        categorias = categoriaRepository.findAll();

                        return ResponseEntity.ok(categorias);
                    } catch (Exception e) {
                        return ResponseEntity.badRequest().body(e.getMessage());
                    }

                }

                @GetMapping(path = "{codigo}")
                @PreAuthorize("hasAuthority('ROLE_PESQUISAR_CATEGORIA') and #oauth2.hasScope('read')")
                public ResponseEntity<?> findById(@PathVariable Long codigo, HttpServletResponse response) {

                    try {
                        Categoria categoria = categoriaRepository.findById(codigo).get();
                
                        URI uri = ServletUriComponentsBuilder.fromCurrentRequestUri().path("")
                                .buildAndExpand(categoria.getCodigo()).toUri();

                        response.setHeader("Location", uri.toASCIIString());

                        return ResponseEntity.ok( categoria );
                    }catch( Exception e) {
                        return ResponseEntity.notFound().build();
                    }
                    
                    
                }

                @PostMapping
                @PreAuthorize("hasAuthority('ROLE_CADASTRAR_CATEGORIA') and #oauth2.hasScope('write')")
                // @ResponseStatus( HttpStatus.CREATED)
                public ResponseEntity<?> insert( @Valid @RequestBody Categoria categoria, HttpServletResponse response ) {
                    /*
                    * if ( result.hasErrors() ) { Map<String, String> errors = new HashMap<>();
                    * 
                    * for ( FieldError error : result.getFieldErrors()) { errors.put(
                    * error.getField(), error.getDefaultMessage()); }
                    * 
                    * return ResponseEntity.unprocessableEntity().body(errors); }
                    */		
                    try {
                        Categoria categoriaSalva = categoriaRepository.save(categoria);

                        URI uri = ServletUriComponentsBuilder.fromCurrentRequestUri().path("/{codigo}")
                                .buildAndExpand(categoriaSalva.getCodigo()).toUri();

                        response.setHeader("Location", uri.toASCIIString());

                        return ResponseEntity.created(uri).body(categoriaSalva);
                    } catch (Exception e) {
                        // TODO Auto-generated catch block
                        return ResponseEntity.badRequest().body(e.getMessage());
                    }

                }

                ...

        . Acesse no Postman a URL localhost:8080/oauth/token:
            
            Authorization; altere o username para mobile e password para m0b1l30

            Body altere o client para mobile, username para admin@algamoney.com e password para admin

        . Execute a URL e transporte o token obtido para a consulta com método POST de categoria e execute a query. Dará erro de 
            insuficiencia de acesso.

        . Retorne ao Postman na URL localhost:8080/oauth/token altere o valor de Authorization para o angular:

            Authorization; altere o username para angular e password para @ngul@r0

        . Execute a URL e transporte o token obtido para a consulta  com método POST de categoria e execute a query. Dessa vez não dará
            mais erro pois agora o client angular possui o escopo write.



Auala 06.14. Implementando o logout
-----------------------------------

    . Insira a classe abaixo no projeto:

        package com.example.algamoneyapi.resource;

        import javax.servlet.http.Cookie;
        import javax.servlet.http.HttpServletRequest;
        import javax.servlet.http.HttpServletResponse;

        import org.springframework.http.HttpStatus;
        import org.springframework.web.bind.annotation.DeleteMapping;
        import org.springframework.web.bind.annotation.RequestMapping;
        import org.springframework.web.bind.annotation.RestController;

        @RestController
        @RequestMapping("/tokens")
        public class TokenResource {

            @DeleteMapping("/revoke")
            public void revoke(HttpServletRequest req, HttpServletResponse resp) {
                Cookie cookie = new Cookie("refreshToken", null);
                cookie.setHttpOnly(true);
                cookie.setSecure(false); // TODO: Em producao sera true
                cookie.setPath(req.getContextPath() + "/oauth/token");
                cookie.setMaxAge(0);
                
                resp.addCookie(cookie);
                resp.setStatus(HttpStatus.NO_CONTENT.value());
            }
            
        }

    . Faça a solicitação de um access token com a url abaixo:

        localhost:8080/oauth/token

        client : angular
        username : admin@algamoney.com
        password : admin
        grant_type : password

    . Observe que veio o Cookie logo ao lado da resposta

    . Crie no Postman uma nova solicitação com método DELETE:

        localhost:8080/tokens/revoke

        . Adicione o access_token obtido do passo anterior na aba Headers com o parâmetro abaixo: 

            Authorization     : Bearer [access_token]

        . Execute a url e observe que não veio o Cookie logo ao lado da resposta




Aula 07.01. Implementando projeção de lançamento        
------------------------------------------------

    . Implemente a classe model abaixo:

        package com.example.algamoney.api.repository.projection;

        import java.math.BigDecimal;
        import java.time.LocalDate;

        import com.example.algamoney.api.model.TipoLancamento;

        public class ResumoLancamento {

            private Long codigo;
            private String descricao;
            private LocalDate dataVencimento;
            private LocalDate dataPagamento;
            private BigDecimal valor;
            private TipoLancamento tipo;
            private String categoria;
            private String pessoa;
            
            public ResumoLancamento(Long codigo, String descricao, LocalDate dataVencimento, LocalDate dataPagamento,
                    BigDecimal valor, TipoLancamento tipo, String categoria, String pessoa) {
                this.codigo = codigo;
                this.descricao = descricao;
                this.dataVencimento = dataVencimento;
                this.dataPagamento = dataPagamento;
                this.valor = valor;
                this.tipo = tipo;
                this.categoria = categoria;
                this.pessoa = pessoa;
            }

            public Long getCodigo() {
                return codigo;
            }

            public void setCodigo(Long codigo) {
                this.codigo = codigo;
            }

            public String getDescricao() {
                return descricao;
            }

            public void setDescricao(String descricao) {
                this.descricao = descricao;
            }

            public LocalDate getDataVencimento() {
                return dataVencimento;
            }

            public void setDataVencimento(LocalDate dataVencimento) {
                this.dataVencimento = dataVencimento;
            }

            public LocalDate getDataPagamento() {
                return dataPagamento;
            }

            public void setDataPagamento(LocalDate dataPagamento) {
                this.dataPagamento = dataPagamento;
            }

            public BigDecimal getValor() {
                return valor;
            }

            public void setValor(BigDecimal valor) {
                this.valor = valor;
            }

            public TipoLancamento getTipo() {
                return tipo;
            }

            public void setTipo(TipoLancamento tipo) {
                this.tipo = tipo;
            }

            public String getCategoria() {
                return categoria;
            }

            public void setCategoria(String categoria) {
                this.categoria = categoria;
            }

            public String getPessoa() {
                return pessoa;
            }

            public void setPessoa(String pessoa) {
                this.pessoa = pessoa;
            }

        }

    . Adicione na interface LancamentoRepositoryQuery o método resumir abaixo:

        ...
        public interface LancamentoRepositoryQuery {

            ...
            public Page<ResumoLancamento> resumir(LancamentoFilter lancamentoFilter, Pageable pageable);

        }    

    . Inserir o método abaixo na classe LancamentoRepositoryImpl

        ...
        @Override
        public Page<ResumoLancamento> resumir(LancamentoFilter lancamentoFilter, Pageable pageable) {
            CriteriaBuilder builder = manager.getCriteriaBuilder();
            CriteriaQuery<ResumoLancamento> criteria = builder.createQuery(ResumoLancamento.class);
            Root<Lancamento> root = criteria.from(Lancamento.class);
            
            criteria.select(builder.construct(ResumoLancamento.class
                    , root.get(Lancamento_.codigo), root.get(Lancamento_.descricao)
                    , root.get(Lancamento_.dataVencimento), root.get(Lancamento_.dataPagamento)
                    , root.get(Lancamento_.valor), root.get(Lancamento_.tipo)
                    , root.get(Lancamento_.categoria).get(Categoria_.nome)
                    , root.get(Lancamento_.pessoa).get(Pessoa_.nome)));
            
            Predicate[] predicates = criarRestricoes(lancamentoFilter, builder, root);
            criteria.where(predicates);
            
            TypedQuery<ResumoLancamento> query = manager.createQuery(criteria);
            adicionarRestricoesDePaginacao(query, pageable);
            
            return new PageImpl<>(query.getResultList(), pageable, total(lancamentoFilter));
        }
        ...

    . Será modificado a assinatura do método adicionarRestricoesDePaginacao 

        de
        --
        private void adicionarRestricoesDePaginacao(TypedQuery<Lancamento> query, Pageable pageable)
                                                    ----------------------
        para
        ----
        private void adicionarRestricoesDePaginacao(TypedQuery<?> query, Pageable pageable) {
                                                    -------------

    . Insira o método abaixo na classe LancamentoResource:

        ...
        @GetMapping(params = "resumo")
        @PreAuthorize("hasAuthority('ROLE_PESQUISAR_LANCAMENTO') and #oauth2.hasScope('read')")
        public Page<ResumoLancamento> resumir(LancamentoFilter lancamentoFilter, Pageable pageable) {
            return lancamentoRepository.resumir(lancamentoFilter, pageable);
        }    
        ...

    . Observe que teremos dois métodos GET. A diferença de qual chamar será o parâmetro "resumo" se houver 
        chamará o método "resumir", caso contrário chamará o método "pesquisar".

    . Levante a aplicação e solicite um access token com a url abaixo:

        localhost:8080/oauth/token

        client : angular
        username : admin@algamoney.com
        password : admin
        grant_type : password    

    . Crie uma nova URL no Postman 

        localhost:8080/lancamentos?resumo

        Header.Authorization : Bearer [Token obtido no item anterior]

    . Altere a URL acima colocando o filtro descrição para ver se continua funcionando:

        localhost:8080/lancamentos?resumo&descricao=Salário


https://www.netsurfingzone.com/jpa/spring-data-jpa-jpql-and-native-query-example/

https://github.com/steppat/modelmapper
http://modelmapper.org/getting-started/#setting-up




Complemento da Aula 07.01. Implementando projeção de lançamento ( com biblioteca ModelMapper )
---------------------------------------------------------------

    . Inclua a dependência abaixo no pom.xml

		<dependency>
			<groupId>org.modelmapper</groupId>
			<artifactId>modelmapper</artifactId>
			<version>2.3.9</version>
		</dependency>

    . Inclua o objeto DTO abaixo no projeto:

        package com.example.algamoneyapi.model;

        import java.math.BigDecimal;
        import java.time.LocalDate;

        public class LancamentoDTO {

            private Long codigo;
            private String descricao;
            private LocalDate dataVencimento;
            private LocalDate dataPagamento;
            private BigDecimal valor;
            private String categoriaNome;
            private String pessoaNome;

            public Long getCodigo() {
                return codigo;
            }

            public void setCodigo(Long codigo) {
                this.codigo = codigo;
            }

            public String getDescricao() {
                return descricao;
            }

            public void setDescricao(String descricao) {
                this.descricao = descricao;
            }

            public LocalDate getDataVencimento() {
                return dataVencimento;
            }

            public void setDataVencimento(LocalDate dataVencimento) {
                this.dataVencimento = dataVencimento;
            }

            public LocalDate getDataPagamento() {
                return dataPagamento;
            }

            public void setDataPagamento(LocalDate dataPagamento) {
                this.dataPagamento = dataPagamento;
            }

            public BigDecimal getValor() {
                return valor;
            }

            public void setValor(BigDecimal valor) {
                this.valor = valor;
            }

            public String getCategoriaNome() {
                return categoriaNome;
            }

            public void setCategoriaNome(String categoriaNome) {
                this.categoriaNome = categoriaNome;
            }

            public String getPessoaNome() {
                return pessoaNome;
            }

            public void setPessoaNome(String pessoaNome) {
                this.pessoaNome = pessoaNome;
            }

            public LancamentoDTO() {
                super();
            }

            public LancamentoDTO(Long codigo, String descricao,
                                LocalDate dataVencimento, LocalDate dataPagamento,
                                BigDecimal valor, String categoriaNome,
                                String pessoaNome) {
                this.codigo = codigo;
                this.descricao = descricao;
                this.dataVencimento = dataVencimento;
                this.dataPagamento = dataPagamento;
                this.valor = valor;
                this.categoriaNome = categoriaNome;
                this.pessoaNome = pessoaNome;
            }

            @Override
            public String toString() {
                return "LancamentoDTO{" +
                        "codigo=" + codigo +
                        ", descricao='" + descricao + '\'' +
                        ", dataVencimento=" + dataVencimento +
                        ", dataPagamento=" + dataPagamento +
                        ", valor=" + valor +
                        ", categoriaNome='" + categoriaNome + '\'' +
                        ", pessoaNome='" + pessoaNome + '\'' +
                        '}';
            }
        }

    . Importante: Existe um padrão na nomenclatura das propriedades que deve ser seguindo.
                    O nome da propriedade categoriaNome e pessoaNome foram colocados dessa
                    forma para atender a padronização pessoa.nome e categoria.nome que é utilizado
                    na classe pai Lancamento, que contêm as propriedade:

                    private Categoria categoria
                    private Pessoa pessoa

                    O ModelMapper utiliza esse padrão para fazer o mapper de uma classe para outra.
                    Mais detalhes acesse o link: http://modelmapper.org/getting-started/#setting-up

    . Crie o método abaixo na classe LancamentoResource:

        @GetMapping(params="resumo")
        public ResponseEntity<?> resumo(){
            List<Lancamento> lancamentos = lancamentoRepository.findAll();

            List<LancamentoDTO> lancamentosDTO = new ArrayList<>();

            ModelMapper modelMapper = new ModelMapper();

            lancamentos.forEach(lancamento -> lancamentosDTO.add( modelMapper.map( lancamento, LancamentoDTO.class) ) );

            return ResponseEntity.ok(lancamentosDTO);
        }


    . Levante a aplicação e solicite um access token com a url abaixo:

        localhost:8080/oauth/token

        client : angular
        username : admin@algamoney.com
        password : admin
        grant_type : password    

    . Crie uma nova URL no Postman 

        localhost:8080/lancamentos?resumo

        Header.Authorization : Bearer [Token obtido no item anterior]



TODO: ver como funcionaria a páginação e o filtro para esse método



Aula 07.02. Profiles do Spring
------------------------------

    . Atenção: Foi verificado que o método da classe "AlgamoneyApiProperty.Seguranca.isEnableHttps" que consta no curso, 
        não funciona. Este método deve ser alterado para "AlgamoneyApiProperty.Seguranca.getEnableHttps", caso contrário
        as configurações nos arquivos *.properties não funcionará. É obrigatório que qq parâmetro incluido no 
        application*.properties deverá ter um correspondente com getter/setter na classe de propriedade, sem isso o conteúdo
        não é atribuido ao objeto injetado.

    . Alterar algumas propriedades das classes que estão "hardcode". A primeira seria na classe TokenResource:


        @RestController
        @RequestMapping("/tokens")
        public class TokenResource {

            @DeleteMapping("/revoke")
            public void revoke(HttpServletRequest req, HttpServletResponse resp){
                Cookie cookie = new Cookie("refreshToke", null);

                cookie.setHttpOnly(true);
                cookie.setSecure(false);                // TODO: Colocar essa propriedade como configurável para produção e no desenv
                cookie.setPath(req.getContextPath());
                cookie.setMaxAge(0);

                resp.addCookie(cookie);
                resp.setStatus(HttpStatus.NO_CONTENT.value());
            }
        }

        . Iremos alterar a propriedade cookie.setSecure(false). Deixaremos ela como configurável para produção e no desenv


    . Inserir a classe abaixo no projeto:

        package com.example.algamoneyapi.config.property;

        import org.springframework.boot.context.properties.ConfigurationProperties;
        import org.springframework.context.annotation.Profile;
        import org.springframework.context.annotation.PropertySource;
        import org.springframework.stereotype.Component;

        @ConfigurationProperties("algamoney")
        public class AlgamoneyApiProperty {

            private String originPermitida; // = "http://localhost:8000";

            private final Seguranca seguranca = new Seguranca();

            public Seguranca getSeguranca() {
                return seguranca;
            }

            public String getOriginPermitida() {
                return originPermitida;
            }

            public void setOriginPermitida(String originPermitida) {
                this.originPermitida = originPermitida;
            }

            public static class Seguranca {

                private boolean enableHttps;        // O default é false, por isso não é colocado nenhum valor

                public boolean getEnableHttps() {
                    return enableHttps;
                }

                public void setEnableHttps(boolean enableHttps) {
                    this.enableHttps = enableHttps;
                }

            }

        }


    . Para utilizar a anotation @ConfigurationProperties é necessário inserir a dependência abaixo no pom.xml:

        <dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-configuration-processor</artifactId>
			<optional>true</optional>
		</dependency>    

    . Inclua a annotation @EnableConfigurationProperties na classe AlgamoneyApiApplication como abaixo:

        @SpringBootApplication
        @EnableConfigurationProperties(AlgamoneyApiProperty.class)
        public class AlgamoneyApiApplication {

            public static void main(String[] args) {
                SpringApplication.run(AlgamoneyApiApplication.class, args);
            }
            
        }

    . A partir daqui é possível utilizar as propriedades da classe AlgamoneyApiProperty e da inner class Seguranca
        dentro do arquivo application.properties. Vá nesse último arquivo e tente colocar a propriedade abaixo para
        verificar:

        algamoney.seguranca.enable-htpps=false

    . Não vamos deixar essa propriedade no arquivo application.properties, ao invés disso iremos criar um novo arquivo
        application-prod.properties e colocar essa propriedade e outras destinadas para a produção:

        algamoney.seguranca.enable-htpps=false

    . Retorne a classe TokenResource e deixe-a como abaixo:

        @RestController
        @RequestMapping("/tokens")
        public class TokenResource {
            
            @Autowired
            private AlgamoneyApiProperty algamoneyApiProperty;

            @DeleteMapping("/revoke")
            public void revoke(HttpServletRequest req, HttpServletResponse resp) {
                Cookie cookie = new Cookie("refreshToken", null);
                cookie.setHttpOnly(true);
                cookie.setSecure(algamoneyApiProperty.getSeguranca().getEnableHttps());
                cookie.setPath(req.getContextPath() + "/oauth/token");
                cookie.setMaxAge(0);
                
                resp.addCookie(cookie);
                resp.setStatus(HttpStatus.NO_CONTENT.value());
            }
            
        }

        . Inclua a propriedade algamoneyApiProperty:

            @Autowired
            private AlgamoneyApiProperty algamoneyApiProperty;

        . Altere a linha do cookie.setSecure como abaixo:

            De

                cookie.setSecure(false);                // TODO: Colocar essa propriedade como configurável para produção e no desenv

            Para

                cookie.setSecure(algamoneyApiProperty.getSeguranca().isEnableHttps());

    . Acesse a classe RefreshTokenPostProcessor e deixe-a como abaixo:
    
        @ControllerAdvice
        public class RefreshTokenPostProcessor implements ResponseBodyAdvice<OAuth2AccessToken> {

            @Autowired
            private AlgamoneyApiProperty algamoneyApiProperty;
            
            @Override
            public boolean supports(MethodParameter returnType, Class<? extends HttpMessageConverter<?>> converterType) {
                return returnType.getMethod().getName().equals("postAccessToken");
            }

            @Override
            public OAuth2AccessToken beforeBodyWrite(OAuth2AccessToken body, MethodParameter returnType,
                    MediaType selectedContentType, Class<? extends HttpMessageConverter<?>> selectedConverterType,
                    ServerHttpRequest request, ServerHttpResponse response) {
                
                HttpServletRequest req = ((ServletServerHttpRequest) request).getServletRequest();
                HttpServletResponse resp = ((ServletServerHttpResponse) response).getServletResponse();
                
                DefaultOAuth2AccessToken token = (DefaultOAuth2AccessToken) body;
                
                String refreshToken = body.getRefreshToken().getValue();
                adicionarRefreshTokenNoCookie(refreshToken, req, resp);
                removerRefreshTokenDoBody(token);
                
                return body;
            }

            private void removerRefreshTokenDoBody(DefaultOAuth2AccessToken token) {
                token.setRefreshToken(null);
            }

            private void adicionarRefreshTokenNoCookie(String refreshToken, HttpServletRequest req, HttpServletResponse resp) {
                Cookie refreshTokenCookie = new Cookie("refreshToken", refreshToken);
                refreshTokenCookie.setHttpOnly(true);
                refreshTokenCookie.setSecure(algamoneyApiProperty.getSeguranca().isEnableHttps());
                refreshTokenCookie.setPath(req.getContextPath() + "/oauth/token");
                refreshTokenCookie.setMaxAge(2592000);
                resp.addCookie(refreshTokenCookie);
            }

        }


        . Inclua a propriedade abaixo na classe acima:

            @Autowired
            private AlgamoneyApiProperty algamoneyApiProperty;

        . Altere a linha abaixo:

            De

                refreshTokenCookie.setSecure(false); // TODO: Mudar para true em producao

            Para

                refreshTokenCookie.setSecure(algamoneyApiProperty.getSeguranca().isEnableHttps());

    . Levante a aplicação e solicite um access token com a url abaixo:

        localhost:8080/oauth/token

        client : angular
        username : admin@algamoney.com
        password : admin
        grant_type : password    

    . Acesse as propriedades da resposta e verifique o conteúdo da propriedade Secure, ela estará como false.

    . Inclua temporariamente a propriedade abaixo no arquivo application.properties, levante novamente a aplicação, 
        solicite um novo access e verifique as propriedades da resposta. Observe que *** NÃO VIRÁ NENHUM COOKIE ***, 
        algo que deverá ocorrer na produção, deixando o cookie invisivel.

        algamoney.seguranca.enable-htpps=true

        ou

        algamoney.seguranca.enableHtpps=true


    . Apague a propriedade acima do arquivo application.properties

    . Altere a propriedade abaixo do arquivo application-prod.properties para:
    
        algamoney.seguranca.enable-htpps=true

    . Levante novamente a aplicação e execute a url abaixo:

        localhost:8080/oauth/token

    . Acesse as propriedades da resposta e verifique o conteúdo da propriedade Secure, ela estará como true.

    . Acesse as propriedades do arquivo application-prod.properties e inclua a propriedade abaixo:

        algamoney.seguranca.enable-https=true

    . Acesse a classe CorsFilter e altere como abaixo:

        @Component
        @Order(Ordered.HIGHEST_PRECEDENCE)
        public class CorsFilter implements Filter {

            @Autowired
            private AlgamoneyApiProperty algamoneyApiProperty;
            
            @Override
            public void doFilter(ServletRequest req, ServletResponse resp, FilterChain chain)
                    throws IOException, ServletException {
                
                HttpServletRequest request = (HttpServletRequest) req;
                HttpServletResponse response = (HttpServletResponse) resp;
                
                response.setHeader("Access-Control-Allow-Origin", algamoneyApiProperty.getOriginPermitida());
                response.setHeader("Access-Control-Allow-Credentials", "true");
                
                if ("OPTIONS".equals(request.getMethod()) && algamoneyApiProperty.getOriginPermitida().equals(request.getHeader("Origin"))) {
                    response.setHeader("Access-Control-Allow-Methods", "POST, GET, DELETE, PUT, OPTIONS");
                    response.setHeader("Access-Control-Allow-Headers", "Authorization, Content-Type, Accept");
                    response.setHeader("Access-Control-Max-Age", "3600");
                    
                    response.setStatus(HttpServletResponse.SC_OK);
                } else {
                    chain.doFilter(req, resp);
                }
                
            }
            
            @Override
            public void destroy() {
            }

            @Override
            public void init(FilterConfig arg0) throws ServletException {
            }

        }


        . Altere a linha abaixo:

            De

                private String originPermitida = "http://localhost:8000"; // TODO: Configurar para diferentes ambientes

            Para 

                @Autowired
                private AlgamoneyApiProperty algamoneyApiProperty;

        . Altere as linhas abaixo:

            De

        		response.setHeader("Access-Control-Allow-Origin", originPermitida);

            Para

                response.setHeader("Access-Control-Allow-Origin", algamoneyApiProperty.getOriginPermitida());            


            De

                if ("OPTIONS".equals(request.getMethod()) && originPermitida.equals(request.getHeader("Origin"))) {...
            
            Para

                if ("OPTIONS".equals(request.getMethod()) && algamoneyApiProperty.getOriginPermitida().equals(request.getHeader("Origin"))) {

    
    . Importante: As alterações feitas na classe CorsFilter só serão possíveis de testar quando o projeto for para num ambiente de produção:
    

Aula 07.05. Nome do usuário no token JWT
----------------------------------------

    . Caso ocorra necessidade de colocar mais informações no Token, podemos usar a técnica dos passos abaixo.

    . Acesse a classe AuthorizationServerConfig e faça as alterações no método config:

        De

            @Override
            public void configure(AuthorizationServerEndpointsConfigurer endpoints) throws Exception {
                endpoints
                        .tokenStore(tokenStore())
                        .accessTokenConverter(accessTokenConverter())       // Linha excluída
                        .reuseRefreshTokens(false)
                        .authenticationManager(authenticationManager);
            }


        Para

            @Override
            public void configure(AuthorizationServerEndpointsConfigurer endpoints) throws Exception {
                TokenEnhancerChain tokenEnhancerChain = new TokenEnhancerChain();                               // Linha incluída
                tokenEnhancerChain.setTokenEnhancers(Arrays.asList(tokenEnhancer(), accessTokenConverter()));   // Linha incluída
                
                endpoints
                    .tokenStore(tokenStore())
                    .tokenEnhancer(tokenEnhancerChain)                  // Linha alterada
                    .reuseRefreshTokens(false)
                    .authenticationManager(authenticationManager);
            }        

        . Foram incluídos as linhas:

            TokenEnhancerChain tokenEnhancerChain = new TokenEnhancerChain();
            tokenEnhancerChain.setTokenEnhancers(Arrays.asList(tokenEnhancer(), accessTokenConverter()));

                endpoints
                    ...
                    .tokenEnhancer(tokenEnhancerChain)                  // Linha alterada
                    ...


    . Acrescente o método abaixo na classe AuthorizationServerConfig:

        @Bean
        public TokenEnhancer tokenEnhancer() {
            return new CustomTokenEnhancer();
        }
	    
    . Crie a classe abaixo no projeto, responsável por incrementar a informação no token:

        package com.example.algamoneyapi.config.token;

        import java.util.HashMap;
        import java.util.Map;

        import org.springframework.security.oauth2.common.DefaultOAuth2AccessToken;
        import org.springframework.security.oauth2.common.OAuth2AccessToken;
        import org.springframework.security.oauth2.provider.OAuth2Authentication;
        import org.springframework.security.oauth2.provider.token.TokenEnhancer;

        import com.example.algamoneyapi.security.UsuarioSistema;

        public class CustomTokenEnhancer implements TokenEnhancer {

            @Override
            public OAuth2AccessToken enhance(OAuth2AccessToken accessToken, OAuth2Authentication authentication) {
                UsuarioSistema usuarioSistema = (UsuarioSistema) authentication.getPrincipal();
                
                Map<String, Object> addInfo = new HashMap<>();
                addInfo.put("nome", usuarioSistema.getUsuario().getNome());
                
                ((DefaultOAuth2AccessToken) accessToken).setAdditionalInformation(addInfo);
                return accessToken;
            }

        }

    . Altere o retorno do métoto AppUserDetailsService.loadUserByUsername como abaixo:

        De

            @Override
            public UserDetails loadUserByUsername(String email) throws UsernameNotFoundException {
                Optional<Usuario> usuarioOptional = usuarioRepository.findByEmail(email);
                Usuario usuario = usuarioOptional.orElseThrow(() -> new UsernameNotFoundException("Usuário e/ou senha incorretos"));
                return new User(email, usuario.getSenha(), getPermissoes(usuario));                                                     // Linha alterada
            }

        Para

            @Override
            public UserDetails loadUserByUsername(String email) throws UsernameNotFoundException {
                Optional<Usuario> usuarioOptional = usuarioRepository.findByEmail(email);
                Usuario usuario = usuarioOptional.orElseThrow(() -> new UsernameNotFoundException("Usuário e/ou senha incorretos"));
                return new UsuarioSistema(usuario, getPermissoes(usuario));                                                             // Linha alterada
            }

    . Inclua a classe abaixo no sistema:

    
        package com.example.algamoneyapi.security;

        import java.util.Collection;

        import org.springframework.security.core.GrantedAuthority;
        import org.springframework.security.core.userdetails.User;

        import com.example.algamoneyapi.model.Usuario;

        public class UsuarioSistema extends User {

            private static final long serialVersionUID = 1L;

            private Usuario usuario;

            public UsuarioSistema(Usuario usuario, Collection<? extends GrantedAuthority> authorities) {
                super(usuario.getEmail(), usuario.getSenha(), authorities);
                this.usuario = usuario;
            }

            public Usuario getUsuario() {
                return usuario;
            }

        }

    . Levante a aplicação e solicite um access token com a url abaixo:

        localhost:8080/oauth/token

        client : angular
        username : admin@algamoney.com
        password : admin
        grant_type : password    

    . Transporte o token gerado, acesse o site https://jwt.io, cole o conteúdo no campo "Encoded" e verifique se 
        o valor "nome" aparece nos itens do Payload do token no campo ao lado do "Encoded".


Aula 07.06. Alternando OAuth 2 e Basic Security com profiles
------------------------------------------------------------

    . Se precisar agilizar a troca do tipo de segurança de OAuth2 para Basic faça as alterações abaixo.

    . Inclua a classe abaixo no projeto:

        package com.example.algamoneyapi.config;

        import org.springframework.beans.factory.annotation.Autowired;
        import org.springframework.context.annotation.Bean;
        import org.springframework.context.annotation.Profile;
        import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;
        import org.springframework.security.config.annotation.web.builders.HttpSecurity;
        import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
        import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;
        import org.springframework.security.config.http.SessionCreationPolicy;
        import org.springframework.security.core.userdetails.UserDetailsService;
        import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
        import org.springframework.security.crypto.password.PasswordEncoder;

        @Profile("basic-security")
        @EnableWebSecurity
        public class BasicSecurityConfig extends WebSecurityConfigurerAdapter {

            @Autowired
            private UserDetailsService userDetailsService;
            
            @Override
            protected void configure(AuthenticationManagerBuilder auth) throws Exception {
                auth.userDetailsService(userDetailsService).passwordEncoder(passwordEncoder());
            }
            
            @Bean
            public PasswordEncoder passwordEncoder() {
                return new BCryptPasswordEncoder();
            }
            
            @Override
            protected void configure(HttpSecurity http) throws Exception {
                http.authorizeRequests()
                        .antMatchers("/h2/**").permitAll()
                        .antMatchers("/h2-console/**").permitAll()
                        .anyRequest().authenticated().and()
                        .headers().frameOptions().sameOrigin().and()
                        .httpBasic()
                        .and()
                        .sessionManagement()
                        .sessionCreationPolicy(SessionCreationPolicy.STATELESS)
                        .and()
                        .csrf().ignoringAntMatchers("/h2-console/**").and()
                        .csrf().ignoringAntMatchers("/h2/**").and()
                        .csrf().disable();
            }
            
        }

    . Através do @Profile é possível fazer essa mudança.

    . Na classe AuthorizationServerConfig coloque a annotation @Profile como abaixo:

        ...
        @Profile("oauth-security")      // Linha incluida
        @Configuration
        @EnableAuthorizationServer
        public class AuthorizationServerConfig extends AuthorizationServerConfigurerAdapter {
        ...

    . Na classe ResourceServerConfig coloque a annotation @Profile como abaixo:

        @Profile("oauth-security")
        @Configuration
        @EnableWebSecurity
        @EnableResourceServer
        @EnableGlobalMethodSecurity( prePostEnabled=true)
        public class ResourceServerConfig extends ResourceServerConfigurerAdapter {
        ...

    . Na classe OAuthSecurityConfig coloque a annotation @Profile como abaixo:
    
        @Profile("oauth-security")      // Linha incluida
        @Configuration
        @EnableWebSecurity
        public class OAuthSecurityConfig extends WebSecurityConfigurerAdapter {
        ...

    . Para configurar qual tipo de token queremos basta configurar no application.properties

        spring.profiles.active=oauth-security

    . Levante a aplicação e solicite um access token com a url abaixo no Postman:

        localhost:8080/oauth/token

        client : angular
        username : admin@algamoney.com
        password : admin
        grant_type : password    

    . Crie uma nova URL no Postman 

        localhost:8080/lancamentos?resumo

        Authoritation.Type : No Auth

        Header.Authorization : Bearer [Token obtido no item anterior]

    . Pare a aplicação.

    . Altere o tipo do token no application.properties como abaixo:

        spring.profiles.active=basic-security

    . Levante a aplicação e no Postman crie uma nova URL como abaixo:

        Method : GET
        URL : http://localhost:8080/categoria
        Authoritation.Type : Basic Auth
        Authorization.Username : admin@algamoney.com
        Authorization.Password : admin

    . Execute a URL e veja se a resposta veio com sucesso:

    
    * Rever a aula e tentar descobrir porque não estou conseguindo acessar pelo Basic Auth como no passo anterior
    * A classe OAuthSecurityConfig não está presente no projeto da Algaworks, para retirar ela do meu projeto
        será preciso copiar o método "authenticationManager" para outra classe
        * Rever a aula para encontrar onde foi colocada e onde foi retirada.
    * No projeto da Algaworks a classe ResourceServerConfig está anotada com @Profile("oauth-security") 
        rever a aula e tentar descobrir se isto foi realmente inserido 
        * O método "passwordEncoder" desta classe está sem a anotação @Bean, comparar com o que está no site 
            da algaworks.
